
#!/usr/bin/env python3
#this belongs in ~/apps/components/ResBio_Evil_Workshop/ResBio_Evil_Workshop.py - Version: 1
# X-Seti - December11 2025 - template - placeholder

"""
Gui dest, Information
"""

import os
import sys
from pathlib import Path
from typing import Optional, List, Dict, Tuple, Any

from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, QSplitter, QListWidget, QListWidgetItem, QLabel, QPushButton, QFileDialog, QMessageBox, QGroupBox, QFormLayout, QLineEdit, QTextEdit, QTableWidget, QTableWidgetItem, QHeaderView, QAbstractItemView, QMenu, QDialog, QCheckBox, QSpinBox, QDoubleSpinBox, QComboBox, QTabWidget, QScrollArea, QFrame, QStackedWidget, QInputDialog, QProgressDialog)


from apps.methods.resbio_svg_icons import ResBioSVGIcons
from PyQt6.QtCore import Qt, pyqtSignal, QSize, QPoint, QRect, QTimer
from PyQt6.QtGui import (
    QFont, QIcon, QPixmap, QColor, QPainter, QPen, QBrush, QAction, QCursor, QKeySequence, QPainterPath)

from depends.svg_icon_factory import SVGIconFactory

# Import AppSettings
try:
    from apps.utils.app_settings_system import AppSettings, SettingsDialog
    APPSETTINGS_AVAILABLE = True
except ImportError:
    APPSETTINGS_AVAILABLE = False
    print("Warning: AppSettings not available")


#from depends.img_debug_functions import img_debugger # TODO - Debugging is status window exists, otherwise the terminal will do.

# OpenGL for 3D viewport
try:
    from PyQt6.QtOpenGLWidgets import QOpenGLWidget
    from OpenGL.GL import *
    from OpenGL.GLU import *
    OPENGL_AVAILABLE = True
except ImportError:
    OPENGL_AVAILABLE = False
    print("Warning: OpenGL not available, 3D viewport disabled")

# Detect if running standalone or docked BEFORE any conditional imports
def _is_standalone():
    """Detect if running standalone (not imported by IMG Factory)"""
    import inspect
    frame = inspect.currentframe()
    try:
        # Check if we're being called from imgfactory.py
        for _ in range(10):  # Check up to 10 frames up
            frame = frame.f_back
            if frame is None:
                break
            if 'imgfactory' in frame.f_code.co_filename.lower():
                return False  # Docked mode
        return True  # Standalone mode
    finally:
        del frame

STANDALONE_MODE = _is_standalone()

App_name = "ResBio-Evil Workshop"
App_build = "December 11 - "
App_auth = "X-Seti"


# Conditional imports based on mode
if STANDALONE_MODE:
    # STANDALONE MODE - Use local depends/ folder
    print(App_name + ": Standalone mode detected")

    # Add current directory to path for depends imports
    current_dir = os.path.dirname(os.path.abspath(__file__))
    if current_dir not in sys.path:
        sys.path.insert(0, current_dir)

    try:
        #from depends.col_core_classes import (
        #    COLFile, COLModel, COLVersion, COLMaterial, COLFaceGroup,
        #    COLSphere, COLBox, COLVertex, COLFace, Vector3, BoundingBox
        #)
        #from depends.col_dialogs import (
        #    show_col_analysis_dialog, show_col_batch_processor,
        #    show_col_file_dialog
        #)
        from depends.svg_icon_factory import SVGIconFactory
        from depends.img_debug_functions import img_debugger
    except ImportError as e:
        print(f"Warning: Missing standalone dependencies: {e}")
        # Minimal fallbacks
        class SVGIconFactory:
            @staticmethod
            def _create_icon(svg_data, size=20, color=None):
                return None

        class img_debugger:
            @staticmethod
            def debug(msg): print(f"DEBUG: {msg}")
            @staticmethod
            def error(msg): print(f"ERROR: {msg}")
            @staticmethod
            def warning(msg): print(f"WARNING: {msg}")
            @staticmethod
            def success(msg): print(f"SUCCESS: {msg}")

        # Minimal COL classes
        class COLFile:
            def __init__(self): pass
        class COLModel:
            def __init__(self): pass

else:
    # DOCKED MODE - Use main app structure (apps.*)
    print(App_name + ": Docked mode detected")

    try:
        from apps.methods.col_core_classes import (
            COLFile, COLModel, COLVersion, COLMaterial, COLFaceGroup,
            COLSphere, COLBox, COLVertex, COLFace, Vector3, BoundingBox
        )
        from apps.gui.col_dialogs import (
            show_col_analysis_dialog, show_col_batch_processor,
            show_col_file_dialog
        )
        from apps.methods.imgfactory_svg_icons import (
            get_save_icon, get_open_icon, get_refresh_icon,
            get_close_icon, get_add_icon, get_remove_icon,
            get_export_icon, get_import_icon, get_settings_icon,
            get_view_icon, get_edit_icon
        )
        from apps.debug.debug_functions import img_debugger
    except ImportError as e:
        print(f"Warning: Missing docked mode imports: {e}")
        # This shouldn't happen in docked mode, but provide fallback
        STANDALONE_MODE = True
        print("Falling back to standalone mode due to import failure")


# OpenGL placeholder (kept for layout compatibility)
OPENGL_AVAILABLE = False

## Method list.
#
#_create_transform_panel
#_create_toolbar
#_create_left_panel
#_create_middle_panel
#_create_right_panel
#_create_preview_controls
#_create_preview_widget
#_create_info_panel
#_create_status_bar
#_create_level_card
#_create_preview_widget
#_create_info_section
#_create_action_section
#_create_stats_grid
#_create_stat_box
#_create_merged_icons_line
#_create_viewport_controls

# Detect mode
def _is_standalone():
    return True

# Fallback minimal classes for structure only
class GenericFile: pass

class GenericObject: pass

class COLVersion: COL_1 = None
class MODVersion: COL_1 = None
class TEXVersion: COL_1 = None

class img_debugger:
    @staticmethod
    def debug(msg): pass
    @staticmethod
    def error(msg): pass
    @staticmethod
    def warning(msg): pass
    @staticmethod
    def success(msg): pass


# - GUI SHELL ONLY BELOW
class ObjListWidget(QListWidget):
    model_selected = pyqtSignal(int)
    model_context_menu = pyqtSignal(int, object)

    def __init__(self, parent=None): #ver 1
        super().__init__(parent)

        self.current_file = None

        # Enable context menu
        self.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.customContextMenuRequested.connect(self.show_context_menu)

        # Connect selection
        self.currentRowChanged.connect(self.on_selection_changed)

    def on_selection_changed(self, row): #ver 1
        if row >= 0:
            self.model_selected.emit(row)

    def show_context_menu(self, position): #ver 1
        item = self.itemAt(position)
        if item:
            model_index = item.data(Qt.ItemDataRole.UserRole)
            self.model_context_menu.emit(model_index, self.mapToGlobal(position))


class GUIPropertiesWidget(QTabWidget): #ver 1
    property_changed = pyqtSignal(str, object)

    def __init__(self, parent=None): #ver 1
        super().__init__(parent)
        self.setup_tabs()

    def setup_tabs(self): #ver 1
        self.model_tab = QWidget()
        self.setup_model_tab()
        self.addTab(self.model_tab, "  Model") # TODO Missing SVG icon for model
        self.spheres_tab = QWidget()
        self.setup_spheres_tab()
        self.addTab(self.spheres_tab, "  Spheres") # TODO Replace with SVG icon for Spheres
        self.boxes_tab = QWidget()
        self.setup_boxes_tab()
        self.addTab(self.boxes_tab, "  Boxes") # TODO Missing SVG icon for Boxes
        self.mesh_tab = QWidget()
        self.setup_mesh_tab()
        self.addTab(self.mesh_tab, "  Mesh") # TODO Missing SVG icon for Mesh
        self.vert_tab = QWidget()
        self.setup_vert_tab()
        self.addTab(self.vert_tab, "  Vertices") # TODO Missing SVG icon for Vertices

        if APPSETTINGS_AVAILABLE:
            try:
                self.app_settings = AppSettings()
                self._load_fonts_from_settings()
            except Exception as e:
                print(f"Warning: Could not load AppSettings: {e}")
                self.app_settings = None
                self.default_font = QFont("Segoe UI", 9)
                self.title_font = QFont("Adwaita Sans", 10)
                self.panel_font = QFont("Adwaita Sans", 9)
                self.button_font = QFont("Adwaita Sans", 9)
        else:
            self.app_settings = None
            self.default_font = QFont("Segoe UI", 9)
            self.title_font = QFont("Adwaita Sans", 10)
            self.panel_font = QFont("Adwaita Sans", 9)
            self.button_font = QFont("Adwaita Sans", 9)

        self._initialize_features()


    def _apply_button_mode(self, dialog): #vers 1
        """Apply button display mode"""
        mode_index = self.button_mode_combo.currentIndex()
        mode_map = {0: 'both', 1: 'icons', 2: 'text'}

        new_mode = mode_map[mode_index]

        if new_mode != self.button_display_mode:
            self.button_display_mode = new_mode
            self._update_all_buttons()

            if self.main_window and hasattr(self.main_window, 'log_message'):
                mode_names = {0: 'Icons + Text', 1: 'Icons Only', 2: 'Text Only'}
                self.main_window.log_message(f"✨ Button style: {mode_names[mode_index]}")

        dialog.close()


# - Window functionality

    def _initialize_features(self): #vers 3
        """Initialize all features after UI setup"""
        try:
            self._apply_theme()
            self._update_status_indicators()

            if self.main_window and hasattr(self.main_window, 'log_message'):
                self.main_window.log_message("All features initialized")

        except Exception as e:
            if self.main_window and hasattr(self.main_window, 'log_message'):
                self.main_window.log_message(f"Feature init error: {str(e)}")


    def _load_fonts_from_settings(self): #vers 1
        """Load font settings from AppSettings"""
        if not self.app_settings:
            return

        settings = self.app_settings

        self.default_font = QFont(
            settings.get('default_font_family', 'Segoe UI'),
            settings.get('default_font_size', 9)
        )

        self.title_font = QFont(
            settings.get('title_font_family', 'Adwaita Sans'),
            settings.get('title_font_size', 10)
        )

        self.panel_font = QFont(
            settings.get('panel_font_family', 'Adwaita Sans'),
            settings.get('panel_font_size', 9)
        )

        self.button_font = QFont(
            settings.get('button_font_family', 'Adwaita Sans'),
            settings.get('button_font_size', 9)
        )

        self.setFont(self.default_font)


    def setup_model_tab(self): #ver 1
        layout = QVBoxLayout(self.model_tab)
        info_group = QGroupBox("Model Information")
        info_layout = QFormLayout(info_group)

        self.model_name_edit = QLineEdit()
        self.model_name_edit.textChanged.connect(lambda text: self.property_changed.emit('name', text))
        info_layout.addRow("Name:", self.model_name_edit)
        self.model_version_combo = QComboBox()

        for version in [COLVersion.COL_1]:
            self.model_version_combo.addItem(f"COL{version}", version)

        info_layout.addRow("Version:", self.model_version_combo)
        self.model_id_spin = QSpinBox()
        self.model_id_spin.setRange(0, 65535)
        self.model_id_spin.valueChanged.connect(lambda value: self.property_changed.emit('model_id', value))

        info_layout.addRow("Object ID:", self.model_id_spin)
        layout.addWidget(info_group)

        bbox_group = QGroupBox("Bounding Box")
        bbox_layout = QFormLayout(bbox_group)
        center_layout = QHBoxLayout()

        self.center_x_spin = QDoubleSpinBox(); self.center_x_spin.setRange(-999999, 999999); self.center_x_spin.setDecimals(3)
        self.center_y_spin = QDoubleSpinBox(); self.center_y_spin.setRange(-999999, 999999); self.center_y_spin.setDecimals(3)
        self.center_z_spin = QDoubleSpinBox(); self.center_z_spin.setRange(-999999, 999999); self.center_z_spin.setDecimals(3)

        center_layout.addWidget(self.center_x_spin); center_layout.addWidget(self.center_y_spin); center_layout.addWidget(self.center_z_spin)
        bbox_layout.addRow("Center (X,Y,Z):", center_layout)

        self.radius_spin = QDoubleSpinBox(); self.radius_spin.setRange(0, 999999); self.radius_spin.setDecimals(3)
        bbox_layout.addRow("Radius:", self.radius_spin)
        layout.addWidget(bbox_group)
        layout.addStretch()

    def setup_spheres_tab(self): #ver 1
        pass

    def setup_boxes_tab(self): #ver 1
        pass

    def setup_mesh_tab(self): #ver 1
        pass

    def setup_vert_tab(self): #ver 1
        pass

    def setup_poly_tab(self): #ver 1
        pass


class App_Settings: # TODO Run app_settings_system.py
    #found in Apps/Utils/app_settings_system.py
    #theme aware logic here.
    pass

class RototePreview(QLabel): #Example
    pass

class PanPreview(QLabel): #Example
    pass

class ZoomablePreview(QLabel): #Example
    # Zoom in and out for right preview panel
    def __init__(self, parent=None): #ver 1
        super().__init__(parent)

        self.setMinimumSize(400, 400)
        self.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.setStyleSheet("border: 1px solid #3a3a3a;")
        self.setMouseTracking(True)
        self.zoom_level = 1.0
        #self.zoom_in()
        #self.zoom_out()
        self.pan_offset = QPoint(0, 0)
        self.bg_color = QColor(42, 42, 42)
        self.placeholder_text = "Select a model to preview"
        self.background_mode = 'solid'
        self._checkerboard_size = 16


    def setPixmap(self, pixmap): #ver 1
        self.update()


    def paintEvent(self, event): #ver 1
        painter = QPainter(self)
        painter.fillRect(self.rect(), self.bg_color)
        painter.setPen(QColor(150, 150, 150))
        painter.drawText(self.rect(), Qt.AlignmentFlag.AlignCenter, self.placeholder_text)


class ResBioEvilWorkshop(QWidget): #ver 1
    workshop_closed = pyqtSignal()
    window_closed = pyqtSignal()

    def __init__(self, parent=None, main_window=None): #ver 1
        super().__init__(parent)

        self.main_window = main_window
        self.undo_stack = []
        self.button_display_mode = 'both'
        self.standalone_mode = (main_window is None)
        self.is_docked = (main_window is not None)
        self.use_system_titlebar = False
        self.window_always_on_top = False
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint)
        self.dragging = False
        self.drag_position = None
        self.resizing = False
        self.resize_corner = None
        self.corner_size = 20
        self.hover_corner = None
        self.setWindowTitle(App_name + ": No File")
        self.resize(1400, 800)
        self.setMouseTracking(True)
        self.dock_display_mode = None
        self.file_form = []

        # Get app_settings from main_window if available
        if main_window and hasattr(main_window, 'app_settings'):
            self.app_settings = main_window.app_settings
        else:
            self.app_settings = None

        # Fonts
        self.setFont(QFont("Fira Sans Condensed", 14))
        self.title_font = QFont("Arial", 14)
        self.panel_font = QFont("Arial", 10)
        self.button_font = QFont("Arial", 10)
        self.infobar_font = QFont("Courier New", 9)

        # Spacing and Margins - MUST BE DEFINED BEFORE setup_ui()
        # TODO: new options for app_system_settings
        self.contmergina = 1
        self.contmerginb = 1
        self.contmerginc = 1
        self.contmergind = 1
        self.setspacing = 2

        # Panel spacing
        self.panelmergina = 5
        self.panelmerginb = 5
        self.panelmerginc = 5
        self.panelmergind = 5
        self.panelspacing = 5

        # TitleBar height - 45
        self.titlebarheight = 45
        self.toolbarheight = 50

        # Status Bar height - 22
        self.tabmerginsa = 5
        self.tabmerginsb = 0
        self.tabmerginsc = 5
        self.tabmerginsd = 0
        self.statusheight = 22

        # Tabbing Bar height - 22
        self.tabbarheight = 22
        self.tabbarspacing = 15

        # Icon only sizes - TODO need to be defined in Local settings and app_system_settings
        self.iconsizex = 64
        self.iconsizey = 64

        # Button icons + text size
        self.buticonsizex = 20
        self.buticonsizey = 20

        # Gadget icons + text size
        self.gadiconsizex = 20
        self.gadiconsizey = 20

        # Preview panel width - 40
        self.previframewidth = 40
        self.previframeheight = 40
        self.ctrlspacing = 10

        # Transform panel width - 50
        self.transframewidth = 50
        self.transframeheight = 50
        self.ctrispacing = 5
        self.ctrlmerginsa = 5
        self.ctrlmerginsb = 5
        self.ctrlmerginsc = 5
        self.ctrlmerginsd = 5

        self.setup_ui()
        self._setup_hotkeys()
        self._apply_theme()

        if hasattr(self, '_update_dock_button_visibility'):
            self._update_dock_button_visibility()


    def get_content_margins(self):
        """Returns main layout margins as a tuple (left, top, right, bottom)"""
        return (self.contmergina, self.contmerginb, self.contmerginc, self.contmergind)

    def get_panel_margins(self):
        """Returns panel layout margins as a tuple (left, top, right, bottom)"""
        return (self.panelmergina, self.panelmerginb, self.panelmerginc, self.panelmergind)

    def get_tab_margins(self):
        """Returns tab layout margins as a tuple (left, top, right, bottom)"""
        return (self.tabmerginsa, self.tabmerginsb, self.tabmerginsc, self.tabmerginsd)

    def get_ctrl_margins(self):
        """Returns control layout margins as a tuple (left, top, right, bottom)"""
        return (self.ctrlmerginsa, self.ctrlmerginsb, self.ctrlmerginsc, self.ctrlmerginsd)


        #Spacing and Mergins # TODO new options for app_system_settings
        self.contmergina = 1; self.contmerginb = 1; self.contmerginc = 1; self.contmergind = 1; self.setspacing = 2

        # Panel spacing.
        self.panelmergina = 5; self.panelmerginb = 5; self.panelmerginc = 5; self.panelmergind = 5; self.panelspacing = 5

        # TitleBar height - 45
        self.titlebarheight = 45; self.toolbarheight = 50

        # Status Bar height - 22
        self.tabmerginsa = 5; self.tabmerginsb = 0; self.tabmerginsc = 5; self.tabmerginsd = 0; self.statusheight = 22

        # Tabbing Bar height - 22
        self.tabbarheight = 22; self.tabbarspacing = 15

        # Icon only sizes = TODO need to be defined in Local settings and app_system_settings
        self.iconsizex = 64; self.iconsizey = 64

        # Button icons + text size
        self.buticonsizex = 20; self.buticonsizey = 20

        # Gadget icons + text size
        self.gadiconsizex = 20; self.gadiconsizey = 20

        # Preview panel width - 40
        self.previframewidth = 40; self.previframeheight = 40; self.ctrlspacing = 10

        # Transform panel width - 50
        self.transframewidth = 50; self.transframeheight = 50; self.ctrispacing = 5; self.ctrlmerginsa = 5; self.ctrlmerginsb = 5; self.ctrlmerginsc = 5; self.ctrlmerginsd = 5


    def setup_ui(self): #ver 1
        #Setup GUI panels.

        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(*self.get_content_margins())
        main_layout.setSpacing(self.setspacing)

        toolbar = self._create_toolbar()
        main_layout.addWidget(toolbar)

        main_splitter = QSplitter(Qt.Orientation.Horizontal)

        left_panel = self._create_left_panel()
        middle_panel = self._create_middle_panel()
        right_panel = self._create_right_panel()

        # Add panels to splitter based on mode
        if left_panel is not None:  # IMG Factory mode
            main_splitter.addWidget(left_panel)
            main_splitter.addWidget(middle_panel)
            main_splitter.addWidget(right_panel)

            # Set proportions (2:3:5)
            main_splitter.setStretchFactor(0, 2)
            main_splitter.setStretchFactor(1, 3)
            main_splitter.setStretchFactor(2, 5)

        else:  # Standalone mode
            main_splitter.addWidget(middle_panel)
            main_splitter.addWidget(right_panel)
            # Set proportions (1:1)

            main_splitter.setStretchFactor(0, 1)
            main_splitter.setStretchFactor(1, 1)

        main_layout.addWidget(main_splitter)

        # Status indicators if available
        if hasattr(self, '_setup_status_indicators'):
            status_frame = self._setup_status_indicators()
            main_layout.addWidget(status_frame)

        # Right panel - 3D viewer
        viewer_group = QGroupBox("3D Viewer")
        viewer_layout = QVBoxLayout(viewer_group)

        #if VIEWPORT_AVAILABLE:
        #    self.viewer_3d = COL3DViewport()
        #    viewer_layout.addWidget(self.viewer_3d)

        #    Add 3DS Max style controls at bottom
        #    controls = self._create_viewport_controls()
        #    viewer_layout.addWidget(controls)
        #else:
        #    self.viewer_3d = QLabel("3D Viewport unavailable\nInstall: pip install PyOpenGL")
        #    self.viewer_3d.setAlignment(Qt.AlignmentFlag.AlignCenter)
        #    viewer_layout.addWidget(self.viewer_3d)

    def _update_status_indicators(self): #vers 1
        pass

    def _apply_fallback_theme(self): #vers 1
        pass


    def _adjust_brightness(self, hex_color, factor=None): #vers 1
        """Adjust color brightness for alternate row colors

        Args:
            hex_color: Hex color string (#RRGGBB)
            factor: Brightness factor (None for auto-detect based on luminance)

        Returns:
            Adjusted hex color string
        """
        try:
            # Convert hex to RGB
            rgb = tuple(int(hex_color.lstrip('#')[i:i+2], 16) for i in (0, 2, 4))

            # Calculate luminance to determine if we should lighten or darken
            luminance = (0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]) / 255

            # Auto-detect factor if not provided
            if factor is None:
                if luminance > 0.5:  # Light theme - darken alternate rows
                    factor = 0.95
                else:  # Dark theme - lighten alternate rows
                    factor = 1.05

            # Apply factor
            new_rgb = tuple(min(255, max(0, int(c * factor))) for c in rgb)
            return f"#{new_rgb[0]:02x}{new_rgb[1]:02x}{new_rgb[2]:02x}"
        except:
            # Return original on error
            return hex_color


    def _apply_file_list_window_theme_styling(self): #vers 7
        """Apply theme styling to the file list window"""
        theme_colors = self._get_theme_colors("default")

        # Extract variables FIRST
        bg_secondary = theme_colors.get('bg_secondary', '#f8f9fa')
        border = theme_colors.get('border', '#dee2e6')
        button_normal = theme_colors.get('button_normal', '#e0e0e0')
        text_primary = theme_colors.get('text_primary', '#000000')
        bg_tertiary = theme_colors.get('bg_tertiary', '#e9ecef')

        if hasattr(self, 'tab_widget'):
            self.tab_widget.setStyleSheet(f"""
                QTabWidget::pane {{
                    background-color: {bg_secondary};
                    border: 1px solid {border};
                    border-radius: 3px;
                }}
                QTabBar::tab {{
                    background-color: {button_normal};
                    color: {text_primary};
                    padding: 5px 10px;
                    margin: 2px;
                    border-radius: 3px;
                }}
                QTabBar::tab:selected {{
                    background-color: {bg_tertiary};
                    border: 1px solid {border};
                }}
            """)

    def apply_table_theme(self): #vers 1
        """Legacy method - Apply theme styling to table and related components"""
        # This method is called by main application for compatibility
        self.apply_all_window_themes()


    def _is_dark_theme(self):
        """
        Returns True if the current theme name ends with _Dark.
        Works with hundreds of themes: Retro_Dark, Amiga_Dark, etc.
        Defaults to dark if theme settings are unavailable.
        """
        if APPSETTINGS_AVAILABLE and hasattr(self, "app_settings") and self.app_settings:
            theme_name = self.app_settings.current_settings.get("theme", "").lower()
            return theme_name.endswith("_dark")

        return True

    def _get_theme_colors(self, theme_name: str): #vers 8
        """Returns a dictionary of theme colors from AppSettings current theme"""

        theme_data = {}
        theme_obj = {}  # Initialize here

        # Get the CURRENT active theme from AppSettings
        if APPSETTINGS_AVAILABLE and self.app_settings:
            if hasattr(self.app_settings, 'current_settings'):
                current_theme_name = self.app_settings.current_settings.get("theme", "")
                debug(f"Current active theme: {current_theme_name}", "THEME")

                # Try to load that theme's colors
                if hasattr(self.app_settings, 'themes') and current_theme_name:
                    theme_obj = self.app_settings.themes.get(current_theme_name, {})
                    debug(f"Theme object keys: {list(theme_obj.keys())}", "THEME")

        # Determine if this theme is dark or light
        is_dark = self._is_dark_theme()
        debug(f"Theme is dark: {is_dark}", "THEME")

        # Only set defaults for MISSING keys (setdefault won't override existing)
        if is_dark:
            theme_data.setdefault("bg_primary", "#1a1a1a")
            theme_data.setdefault("bg_secondary", "#2a2a2a")
            theme_data.setdefault("text_primary", "#ffffff")
            theme_data.setdefault("text_secondary", "#cccccc")
            theme_data.setdefault("accent", "#00d8ff")
            theme_data.setdefault("border", "#3a3a3a")
            theme_data.setdefault("panel_bg", "#2d2d2d")
            theme_data.setdefault("accent_primary", "#00d8ff")
            theme_data.setdefault("button_normal", "#404040")
        else:
            theme_data.setdefault("bg_primary", "#ffffff")
            theme_data.setdefault("bg_secondary", "#f8f9fa")
            theme_data.setdefault("text_primary", "#000000")
            theme_data.setdefault("text_secondary", "#495057")
            theme_data.setdefault("accent", "#1976d2")
            theme_data.setdefault("border", "#dee2e6")
            theme_data.setdefault("panel_bg", "#f0f0f0")
            theme_data.setdefault("accent_primary", "#1976d2")
            theme_data.setdefault("button_normal", "#e0e0e0")

        # Build tearoff button stylesheet
        if is_dark:
            button_style = f"""
                QPushButton {{
                    border: 1px solid {theme_data['border']};
                    border-radius: 1px;
                    background-color: {theme_data['bg_secondary']};
                    color: {theme_data['text_primary']};
                    font-size: 12px;
                    font-weight: bold;
                    padding: 0px;
                    margin: 2px;
                }}
                QPushButton:hover {{
                    background-color: {theme_data['accent']};
                    border: 1px solid {theme_data['border']};
                    color: {theme_data['text_secondary']};
                }}
                QPushButton:pressed {{
                    background-color: {theme_data['bg_primary']};
                    border: 1px solid {theme_data['border']};
                    color: {theme_data['text_primary']};
                }}
            """
        else:
            button_style = f"""
                QPushButton {{
                    border: 1px solid {theme_data['border']};
                    border-radius: 1px;
                    background-color: {theme_data['bg_primary']};
                    color: {theme_data['text_primary']};
                    font-size: 12px;
                    font-weight: bold;
                    padding: 0px;
                    margin: 2px;
                }}
                QPushButton:hover {{
                    background-color: {theme_data['accent']};
                    border: 1px solid {theme_data['border']};
                    color: {theme_data['text_secondary']};
                }}
                QPushButton:pressed {{
                    background-color: {theme_data['bg_secondary']};
                    border: 1px solid {theme_data['border']};
                    color: {theme_data['text_primary']};
                }}
            """

        # Inject button style into theme data
        theme_data["button_style"] = button_style

        return theme_data


    def _apply_theme(self): #vers 9
        """Apply comprehensive theme to all GUI elements with direct widget styling"""

        if self.app_settings and APPSETTINGS_AVAILABLE:
            # Get base AppSettings stylesheet
            base_stylesheet = self.app_settings.get_stylesheet()

            # Get theme colors for MEL-specific styling
            theme_colors = self._get_theme_colors("default")

            # Calculate alternate row color
            panel_bg = theme_colors.get('panel_bg', '#f0f0f0')
            panel_bg_alt = self._adjust_brightness(panel_bg)

            # Get other themed colors
            text_primary = theme_colors.get('text_primary', '#000000')
            border = theme_colors.get('border', '#dee2e6')
            accent = theme_colors.get('accent_primary', '#1976d2')
            bg_primary = theme_colors.get('bg_primary', '#ffffff')

            # Calculate button color with good contrast
            # Check if theme is light or dark
            bg_rgb = tuple(int(bg_primary.lstrip('#')[i:i+2], 16) for i in (0, 2, 4))
            luminance = (0.299 * bg_rgb[0] + 0.587 * bg_rgb[1] + 0.114 * bg_rgb[2]) / 255

            if luminance > 0.5:
                # Light theme - darken button background significantly for visibility
                button_bg = self._adjust_brightness(bg_primary, 0.85)  # Much darker
            else:
                # Dark theme - lighten button background
                button_bg = self._adjust_brightness(bg_primary, 1.15)

            print(f"Button background calculated: {button_bg} (from bg_primary {bg_primary}, luminance {luminance:.2f})")

            # Calculate hover/pressed colors
            accent_hover = self._adjust_brightness(accent, 0.9)
            button_hover = self._adjust_brightness(button_bg, 0.95)

            # Apply base stylesheet first
            self.setStyleSheet(base_stylesheet)

            # Now apply MEL-specific styling DIRECTLY to widgets to override AppSettings
            # This ensures our styles take precedence

            # Style platform list
            if hasattr(self, 'platform_list'):
                self.platform_list.setStyleSheet(f"""
                    QListWidget {{
                        background-color: {bg_primary} !important;
                        color: {text_primary} !important;
                        border: 1px solid {border} !important;
                        border-radius: 4px;
                        padding: 2px;
                    }}
                    QListWidget::item {{
                        padding: 5px;
                        border-radius: 3px;
                        color: {text_primary} !important;
                    }}
                    QListWidget::item:alternate {{
                        background-color: {panel_bg_alt} !important;
                    }}
                    QListWidget::item:selected {{
                        background-color: {accent} !important;
                        color: #FFFFFF !important;
                    }}
                    QListWidget::item:hover {{
                        background-color: {accent_hover} !important;
                    }}
                """)

            # Style game list
            if hasattr(self, 'game_list'):
                self.game_list.setStyleSheet(f"""
                    QListWidget {{
                        background-color: {bg_primary} !important;
                        color: {text_primary} !important;
                        border: 1px solid {border} !important;
                        border-radius: 4px;
                        padding: 2px;
                    }}
                    QListWidget::item {{
                        padding: 5px;
                        border-radius: 3px;
                        color: {text_primary} !important;
                    }}
                    QListWidget::item:alternate {{
                        background-color: {panel_bg_alt} !important;
                    }}
                    QListWidget::item:selected {{
                        background-color: {accent} !important;
                        color: #FFFFFF !important;
                    }}
                    QListWidget::item:hover {{
                        background-color: {accent_hover} !important;
                    }}
                """)

            # Style display widget frame
            if hasattr(self, 'display_widget') and hasattr(self.display_widget, 'display_frame'):
                self.display_widget.display_frame.setStyleSheet(f"""
                    QFrame {{
                        background-color: {bg_primary} !important;
                        border: 2px solid {border} !important;
                        border-radius: 4px;
                    }}
                """)

            # Apply titlebar colors
            self._apply_titlebar_colors()

            # Style bottom control buttons for better visibility
            #self._style_control_buttons(button_bg, text_primary, accent, border)

            # Apply fonts from AppSettings to widgets
            self._apply_fonts_to_widgets()
        else:
            # Fallback when AppSettings not available
            self._apply_fallback_theme()


    def _get_icon_color(self): #vers 1
        """Get icon color from current theme"""
        if APPSETTINGS_AVAILABLE and self.app_settings:
            colors = self.app_settings.get_theme_colors()
            return colors.get('text_primary', '#ffffff')
        return '#ffffff'


    def _apply_fonts_to_widgets(self): #vers 1
        """Apply fonts from AppSettings to all widgets"""
        if not hasattr(self, 'default_font'):
            return

        print("\n=== Applying Fonts ===")
        print(f"Default font: {self.default_font.family()} {self.default_font.pointSize()}pt")
        print(f"Title font: {self.title_font.family()} {self.title_font.pointSize()}pt")
        print(f"Panel font: {self.panel_font.family()} {self.panel_font.pointSize()}pt")
        print(f"Button font: {self.button_font.family()} {self.button_font.pointSize()}pt")

        # Apply default font to main window
        self.setFont(self.default_font)

        # Apply title font to titlebar
        if hasattr(self, 'title_label'):
            self.title_label.setFont(self.title_font)

        # Apply panel font to lists
        if hasattr(self, 'platform_list'):
            self.platform_list.setFont(self.panel_font)
        if hasattr(self, 'game_list'):
            self.game_list.setFont(self.panel_font)

        # Apply button font to all buttons
        for btn in self.findChildren(QPushButton):
            btn.setFont(self.button_font)

        print("âœ“ Fonts applied to widgets")
        print("======================\n")

    def _style_control_buttons(self, button_bg, text_color, accent_color, border_color): #vers 4
        """Style control buttons to match titlebar buttons exactly

        Args:
            button_bg: Background color from titlebar calculation
            text_color: Text color from titlebar calculation
            accent_color: Accent color for hover
            border_color: Border color from theme
        """

        # Use exact same style as titlebar buttons
        button_style = f"""
            QPushButton {{
                background-color: {button_bg} !important;
                border: 1px solid {border_color} !important;
                border-radius: 3px;
                color: {text_color} !important;
                padding: 5px 10px;
                font-weight: bold;
                min-height: 30px;
            }}
            QPushButton:hover {{
                background-color: {accent_color} !important;
                border-color: {border_color} !important;
                color: #FFFFFF !important;
            }}
            QPushButton:pressed {{
                background-color: {self._adjust_brightness(accent_color, 0.85)} !important;
            }}
            QPushButton:disabled {{
                background-color: {self._adjust_brightness(button_bg, 1.05)} !important;
                color: #888888 !important;
                border-color: #555555 !important;
            }}
        """

        # Apply to all buttons in display widget
        if hasattr(self, 'display_widget'):
            for btn in self.display_widget.findChildren(QPushButton):
                btn.setStyleSheet(button_style)


    def _apply_theme_not_found(self): #vers 5
        """Apply theme to all GUI elements - comprehensive styling"""

        if self.app_settings and APPSETTINGS_AVAILABLE:
            # Get base AppSettings stylesheet
            stylesheet = self.app_settings.get_stylesheet()

            # Get theme colors for MEL-specific widgets
            theme_colors = self._get_theme_colors("default")

            # Extract all colors from theme
            bg_primary = theme_colors.get('bg_primary', '#1f2f39')
            bg_secondary = theme_colors.get('bg_secondary', '#293f4d')
            bg_tertiary = theme_colors.get('bg_tertiary', '#18242d')
            panel_bg = theme_colors.get('panel_bg', '#253447')

            accent_primary = theme_colors.get('accent_primary', '#4f6f7A')
            accent_secondary = theme_colors.get('accent_secondary', '#657682')

            text_primary = theme_colors.get('text_primary', '#FFFFFF')
            text_secondary = theme_colors.get('text_secondary', '#E2FFE9')
            text_accent = theme_colors.get('text_accent', '#AFCFAF')

            button_normal = theme_colors.get('button_normal', '#2f3f49')
            button_hover = theme_colors.get('button_hover', '#0f0f09')
            button_pressed = theme_colors.get('button_pressed', '#5f6f79')
            button_text = theme_colors.get('button_text_color', '#FFFFFF')

            border = theme_colors.get('border', '#135379')

            splitter_bg = theme_colors.get('splitter_color_background', '#243845')
            splitter_shine = theme_colors.get('splitter_color_shine', '#3e525e')
            splitter_shadow = theme_colors.get('splitter_color_shadow', '#1f2f39')

            scrollbar_bg = theme_colors.get('scrollbar_background', '#1d2c36')
            scrollbar_handle = theme_colors.get('scrollbar_handle', '#114a6c')
            scrollbar_handle_hover = theme_colors.get('scrollbar_handle_hover', '#0f4260')
            scrollbar_handle_pressed = theme_colors.get('scrollbar_handle_pressed', '#0d3a54')
            scrollbar_border = theme_colors.get('scrollbar_border', '#135379')

            selection_bg = theme_colors.get('selection_background', '#4f6f7A')
            selection_text = theme_colors.get('selection_text', '#ffffff')

            # Comprehensive MEL stylesheet
            mel_stylesheet = f"""
                /* Main Window */
                QWidget {{
                    background-color: {bg_primary};
                    color: {text_primary};
                }}

                /* Frames and Panels */
                QFrame {{
                    background-color: {panel_bg};
                    border: 1px solid {border};
                    border-radius: 4px;
                }}

                QFrame[frameShape="4"] {{  /* StyledPanel */
                    background-color: {panel_bg};
                    border: 1px solid {border};
                }}

                /* Group Boxes */
                QGroupBox {{
                    background-color: {panel_bg};
                    border: 2px solid {border};
                    border-radius: 5px;
                    margin-top: 10px;
                    padding-top: 15px;
                    color: {text_primary};
                    font-weight: bold;
                }}

                QGroupBox::title {{
                    subcontrol-origin: margin;
                    subcontrol-position: top left;
                    padding: 5px 10px;
                    color: {text_primary};
                    background-color: {bg_secondary};
                    border: 1px solid {border};
                    border-radius: 3px;
                }}

                /* Buttons */
                QPushButton {{
                    background-color: {button_normal};
                    border: 1px solid {border};
                    border-radius: 4px;
                    padding: 6px 12px;
                    color: {button_text};
                    min-height: 30px;
                }}

                QPushButton:hover {{
                    background-color: {button_hover};
                    border-color: {accent_primary};
                }}

                QPushButton:pressed {{
                    background-color: {button_pressed};
                    border-color: {accent_secondary};
                }}

                QPushButton:disabled {{
                    background-color: {bg_tertiary};
                    color: {text_secondary};
                    border-color: {border};
                }}

                /* Lists */
                QListWidget {{
                    background-color: {bg_primary};
                    alternate-background-color: {bg_secondary};
                    border: 1px solid {border};
                    border-radius: 4px;
                    color: {text_primary};
                    selection-background-color: {selection_bg};
                    selection-color: {selection_text};
                }}

                QListWidget::item {{
                    padding: 5px;
                    border-bottom: 1px solid {bg_tertiary};
                }}

                QListWidget::item:selected {{
                    background-color: {selection_bg};
                    color: {selection_text};
                }}

                QListWidget::item:hover {{
                    background-color: {accent_primary};
                }}

                /* Splitters */
                QSplitter::handle:horizontal {{
                    background-color: {splitter_bg};
                    border: 1px solid {splitter_shadow};
                    border-left: 1px solid {splitter_shine};
                    width: 8px;
                    margin: 2px;
                    border-radius: 3px;
                }}

                QSplitter::handle:horizontal:hover {{
                    background-color: {splitter_shine};
                }}

                QSplitter::handle:vertical {{
                    background-color: {splitter_bg};
                    border: 1px solid {splitter_shadow};
                    border-top: 1px solid {splitter_shine};
                    height: 8px;
                    margin: 2px;
                    border-radius: 3px;
                }}

                QSplitter::handle:vertical:hover {{
                    background-color: {splitter_shine};
                }}

                /* Scrollbars */
                QScrollBar:vertical {{
                    background-color: {scrollbar_bg};
                    width: 12px;
                    border: 1px solid {scrollbar_border};
                    border-radius: 3px;
                }}

                QScrollBar::handle:vertical {{
                    background-color: {scrollbar_handle};
                    min-height: 20px;
                    border-radius: 3px;
                    margin: 2px;
                }}

                QScrollBar::handle:vertical:hover {{
                    background-color: {scrollbar_handle_hover};
                }}

                QScrollBar::handle:vertical:pressed {{
                    background-color: {scrollbar_handle_pressed};
                }}

                QScrollBar::add-line:vertical,
                QScrollBar::sub-line:vertical {{
                    height: 0px;
                }}

                QScrollBar:horizontal {{
                    background-color: {scrollbar_bg};
                    height: 12px;
                    border: 1px solid {scrollbar_border};
                    border-radius: 3px;
                }}

                QScrollBar::handle:horizontal {{
                    background-color: {scrollbar_handle};
                    min-width: 20px;
                    border-radius: 3px;
                    margin: 2px;
                }}

                QScrollBar::handle:horizontal:hover {{
                    background-color: {scrollbar_handle_hover};
                }}

                QScrollBar::handle:horizontal:pressed {{
                    background-color: {scrollbar_handle_pressed};
                }}

                QScrollBar::add-line:horizontal,
                QScrollBar::sub-line:horizontal {{
                    width: 0px;
                }}

                /* Labels */
                QLabel {{
                    color: {text_primary};
                    background-color: transparent;
                }}

                /* Line Edits */
                QLineEdit {{
                    background-color: {bg_secondary};
                    border: 1px solid {border};
                    border-radius: 3px;
                    padding: 5px;
                    color: {text_primary};
                    selection-background-color: {selection_bg};
                    selection-color: {selection_text};
                }}

                QLineEdit:focus {{
                    border: 2px solid {accent_primary};
                }}

                /* Checkboxes */
                QCheckBox {{
                    color: {text_primary};
                    spacing: 5px;
                }}

                QCheckBox::indicator {{
                    width: 18px;
                    height: 18px;
                    border: 1px solid {border};
                    border-radius: 3px;
                    background-color: {bg_secondary};
                }}

                QCheckBox::indicator:checked {{
                    background-color: {accent_primary};
                    border-color: {accent_secondary};
                }}

                QCheckBox::indicator:hover {{
                    border-color: {accent_primary};
                }}

                /* Radio Buttons */
                QRadioButton {{
                    color: {text_primary};
                    spacing: 5px;
                }}

                QRadioButton::indicator {{
                    width: 18px;
                    height: 18px;
                    border: 1px solid {border};
                    border-radius: 9px;
                    background-color: {bg_secondary};
                }}

                QRadioButton::indicator:checked {{
                    background-color: {accent_primary};
                    border-color: {accent_secondary};
                }}

                QRadioButton::indicator:hover {{
                    border-color: {accent_primary};
                }}

                /* Status Bar */
                QStatusBar {{
                    background-color: {bg_tertiary};
                    color: {text_secondary};
                    border-top: 1px solid {border};
                }}

                /* Dialogs */
                QDialog {{
                    background-color: {bg_primary};
                    color: {text_primary};
                }}

                /* Tab Widget */
                QTabWidget::pane {{
                    background-color: {panel_bg};
                    border: 1px solid {border};
                    border-radius: 4px;
                }}

                QTabBar::tab {{
                    background-color: {button_normal};
                    color: {button_text};
                    padding: 8px 16px;
                    margin: 2px;
                    border: 1px solid {border};
                    border-bottom: none;
                    border-top-left-radius: 4px;
                    border-top-right-radius: 4px;
                }}

                QTabBar::tab:selected {{
                    background-color: {panel_bg};
                    border-bottom: 2px solid {accent_primary};
                }}

                QTabBar::tab:hover {{
                    background-color: {button_hover};
                }}
            """

            # Apply combined stylesheet
            self.setStyleSheet(stylesheet + mel_stylesheet)

            # Apply titlebar colors
            self._apply_titlebar_colors()
        else:
            # Fallback theme when AppSettings not available
            self._apply_log_theme_styling()
            self._apply_vertical_splitter_theme()
            self._apply_main_splitter_theme()
            self._apply_status_window_theme_styling()
            self._apply_file_list_window_theme_styling()


    def _apply_titlebar_colors(self): #vers 9
        """Apply theme colors to titlebar elements - respects themed setting and detects light/dark"""
        if not self.app_settings:
            return

        # Check if themed titlebar is enabled from MEL settings
        use_themed = self.mel_settings.settings.get('use_themed_titlebar', True)

        # Get theme colors
        theme_colors = self._get_theme_colors("default")

        if not use_themed:
            # Hardcoded high-contrast colors for visibility
            text_color = '#FFFFFF'
            bg_color = '#2c3e50'
            accent_color = '#3498db'
            button_text_color = '#FFFFFF'
            button_bg_color = '#3498db'
            border_color = '#2c3e50'
        else:
            # Use theme colors
            text_color = theme_colors.get('text_primary', '#000000')
            bg_color = theme_colors.get('panel_bg', '#ffffff')
            accent_color = theme_colors.get('accent', '#1976d2')
            border_color = theme_colors.get('border', '#dee2e6')

            # Detect if theme is light or dark based on background brightness
            bg_rgb = tuple(int(bg_color.lstrip('#')[i:i+2], 16) for i in (0, 2, 4))
            luminance = (0.299 * bg_rgb[0] + 0.587 * bg_rgb[1] + 0.114 * bg_rgb[2]) / 255

            # Light theme (bright background): use dark buttons
            # Dark theme (dark background): use light buttons
            if luminance > 0.5:
                # Light theme - use theme colors
                button_text_color = theme_colors.get('text_primary', '#2c3e50')
                button_bg_color = theme_colors.get('button_normal', '#e0e0e0')
            else:
                # Dark theme - use light colors
                button_text_color = '#FFFFFF'
                button_bg_color = theme_colors.get('button_normal', '#404040')

        # Apply to title label
        if hasattr(self, 'title_label'):
            self.title_label.setStyleSheet(f"""
                QLabel {{
                    color: {text_color} !important;
                    background-color: {bg_color} !important;
                    font-weight: bold;
                    padding: 5px;
                }}
            """)

        # Create unified button style for ALL buttons
        button_style = f"""
            QPushButton {{
                background-color: {button_bg_color} !important;
                border: 1px solid {border_color} !important;
                border-radius: 3px;
                color: {button_text_color} !important;
                padding: 2px;
                font-weight: bold;
            }}
            QPushButton:hover {{
                background-color: {accent_color} !important;
                border-color: {border_color} !important;
                color: #FFFFFF !important;
            }}
            QPushButton:pressed {{
                background-color: {self._adjust_brightness(accent_color, 0.85)} !important;
            }}
        """

        # Apply to ALL titlebar buttons
        titlebar_buttons = [
            'settings_btn', 'scan_bios_btn', 'scan_roms_btn', 'save_btn', 'controller_btn',
            'properties_btn', 'minimize_btn', 'maximize_btn', 'close_btn'
        ]

        for btn_name in titlebar_buttons:
            if hasattr(self, btn_name):
                btn = getattr(self, btn_name)
                btn.setStyleSheet(button_style)

        # Apply to sidebar control buttons
        sidebar_buttons = ['vol_up_btn', 'vol_down_btn', 'screenshot_btn', 'record_btn']
        for btn_name in sidebar_buttons:
            if hasattr(self, btn_name):
                btn = getattr(self, btn_name)
                btn.setStyleSheet(button_style)

        # Now style the bottom buttons with the same colors
        self._style_control_buttons(button_bg_color, button_text_color, accent_color, border_color)


    def _on_theme_changed(self): #vers 4
        """Handle theme changes - refresh everything including icons"""
        self._apply_theme()
        self._apply_titlebar_colors()

        # Refresh ALL icons with new theme color
        icon_color = self._get_icon_color()

        # Titlebar button icons
        if hasattr(self, 'settings_btn'):
            self.settings_btn.setIcon(ResBioSVGIcons.settings_icon(20, icon_color))
        if hasattr(self, 'scan_bios_btn'):
            self.scan_bios_btn.setIcon(ResBioSVGIcons.chip_icon(20, icon_color))
        if hasattr(self, 'scan_roms_btn'):
            self.scan_roms_btn.setIcon(ResBioSVGIcons.folder_icon(20, icon_color))
        if hasattr(self, 'save_btn'):
            self.save_btn.setIcon(ResBioSVGIcons.save_icon(20, icon_color))
        if hasattr(self, 'controller_btn'):
            self.controller_btn.setIcon(ResBioSVGIcons.controller_icon(20, icon_color))
        if hasattr(self, 'info_btn'):
            self.info_btn.setIcon(ResBioSVGIcons.info_icon(24, icon_color))
        if hasattr(self, 'properties_btn'):
            self.properties_btn.setIcon(ResBioSVGIcons.properties_icon(24, icon_color))

        # Window control icons
        if hasattr(self, 'minimize_btn'):
            self.minimize_btn.setIcon(ResBioSVGIcons.minimize_icon(20, icon_color))
        if hasattr(self, 'maximize_btn'):
            self.maximize_btn.setIcon(ResBioSVGIcons.maximize_icon(20, icon_color))
        if hasattr(self, 'close_btn'):
            self.close_btn.setIcon(ResBioSVGIcons.close_icon(20, icon_color))

        # Icon control panel icons
        if hasattr(self, 'vol_up_btn'):
            self.vol_up_btn.setIcon(ResBioSVGIcons.volume_up_icon(20, icon_color))
        if hasattr(self, 'vol_down_btn'):
            self.vol_down_btn.setIcon(ResBioSVGIcons.volume_down_icon(20, icon_color))
        if hasattr(self, 'screenshot_btn'):
            self.screenshot_btn.setIcon(ResBioSVGIcons.screenshot_icon(20, icon_color))


    def _refresh_svg_icons(self): #vers 5
        """Recreate all SVG icons with current theme colors"""

        # Titlebar window controls
        if hasattr(self, 'minimize_btn'):
            self.minimize_btn.setIcon(ResBioSVGIcons.minimize_icon(20, icon_color))
            self.minimize_btn.repaint()  # Force visual update
        if hasattr(self, 'maximize_btn'):
            self.maximize_btn.setIcon(ResBioSVGIcons.maximize_icon(20, icon_color))
            self.maximize_btn.repaint()
        if hasattr(self, 'close_btn'):
            self.close_btn.setIcon(ResBioSVGIcons.close_icon(20, icon_color))
            self.close_btn.repaint()
        if hasattr(self, 'properties_btn'):
            self.properties_btn.setIcon(ResBioSVGIcons.properties_icon(24, icon_color))
            self.properties_btn.repaint()
        if hasattr(self, 'info_btn'):
            self.info_btn.setIcon(ResBioSVGIcons.info_icon(24, icon_color))
            self.info_btn.repaint()


        # Titlebar main buttons
        if hasattr(self, 'scan_bios_btn'):
            self.scan_bios_btn.setIcon(ResBioSVGIcons.chip_icon(20, icon_color))
            self.scan_bios_btn.repaint()

        if hasattr(self, 'scan_roms_btn'):
            self.scan_roms_btn.setIcon(ResBioSVGIcons.folder_icon(16, icon_color))
        if hasattr(self, 'save_btn'):
            self.save_btn.setIcon(ResBioSVGIcons.save_icon(16, icon_color))
        if hasattr(self, 'controller_btn'):
            self.controller_btn.setIcon(ResBioSVGIcons.controller_icon(16, icon_color))
        if hasattr(self, 'settings_btn'):
            self.settings_btn.setIcon(ResBioSVGIcons.settings_icon(16, icon_color))


        # Sidebar control buttons - FORCE REFRESH
        if hasattr(self, 'vol_up_btn'):
            self.vol_up_btn.setIcon(ResBioSVGIcons.volume_up_icon(20, icon_color))
            self.vol_up_btn.update()  # Force Qt to redraw
            self.vol_up_btn.repaint()
        if hasattr(self, 'vol_down_btn'):
            self.vol_down_btn.setIcon(ResBioSVGIcons.volume_down_icon(20, icon_color))
            self.vol_down_btn.update()
            self.vol_down_btn.repaint()
        if hasattr(self, 'screenshot_btn'):
            self.screenshot_btn.setIcon(ResBioSVGIcons.screenshot_icon(20, icon_color))
            self.screenshot_btn.update()
            self.screenshot_btn.repaint()
        if hasattr(self, 'record_btn'):
            self.record_btn.setIcon(ResBioSVGIcons.record_icon(20))
            self.record_btn.update()
            self.record_btn.repaint()

        # Bottom panel buttons
        if hasattr(self, 'display_widget'):
            icon_color = self._get_icon_color()
            if hasattr(self.display_widget, 'launch_btn'):
                self.display_widget.launch_btn.setIcon(ResBioSVGIcons.launch_icon(20, icon_color))
                self.display_widget.launch_btn.repaint()
            if hasattr(self.display_widget, 'load_core_btn'):
                self.display_widget.load_core_btn.setIcon(ResBioSVGIcons.folder_icon(20, icon_color))
                self.display_widget.load_core_btn.repaint()
            if hasattr(self.display_widget, 'gameart_btn'):
                self.display_widget.gameart_btn.setIcon(ResBioSVGIcons.paint_icon(20, icon_color))
                self.display_widget.gameart_btn.repaint()
            if hasattr(self.display_widget, 'manage_btn'):
                self.display_widget.manage_btn.setIcon(ResBioSVGIcons.manage_icon(20, icon_color))
                self.display_widget.manage_btn.repaint()
            if hasattr(self.display_widget, 'ports_btn'):
                self.display_widget.ports_btn.setIcon(ResBioSVGIcons.package_icon(20, icon_color))
                self.display_widget.ports_btn.repaint()
            if hasattr(self.display_widget, 'stop_btn'):
                self.display_widget.stop_btn.setIcon(ResBioSVGIcons.stop_icon(20, icon_color))
                self.display_widget.stop_btn.repaint()



# - Panel Creation

    def _create_toolbar(self): #vers 1
        #Create toolbar - FIXED: Hide drag button when docked, ensure buttons visible
        from depends.svg_icon_factory import SVGIconFactory

        self.research_tab = None  # Initialize research tab reference
        self.titlebar = QFrame()
        self.titlebar.setFrameStyle(QFrame.Shape.StyledPanel)
        self.titlebar.setFixedHeight(self.titlebarheight)
        self.titlebar.setObjectName("titlebar")

        # Install event filter for drag detection
        self.titlebar.installEventFilter(self)
        self.titlebar.setAttribute(Qt.WidgetAttribute.WA_TransparentForMouseEvents, False)
        self.titlebar.setMouseTracking(True)

        self.layout = QHBoxLayout(self.titlebar)
        self.layout.setContentsMargins(*self.get_content_margins())
        self.layout.setSpacing(self.setspacing)

        # Get icon color from theme
        icon_color = self._get_icon_color()

        self.toolbar = QFrame()
        self.toolbar.setFrameStyle(QFrame.Shape.StyledPanel)
        self.toolbar.setMaximumHeight(self.toolbarheight)

        layout = QHBoxLayout(self.toolbar)
        layout.setContentsMargins(*self.get_panel_margins())
        layout.setSpacing(self.panelspacing)

        # Settings button
        self.settings_btn = QPushButton()
        self.settings_btn.setFont(self.button_font)
        self.settings_btn.setIcon(self._create_settings_icon())
        self.settings_btn.setText("Settings")
        self.settings_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        self.settings_btn.clicked.connect(self._show_workshop_settings)
        self.settings_btn.setToolTip("Workshop Settings")
        layout.addWidget(self.settings_btn)

        layout.addStretch()

        # App title in center
        self.title_label = QLabel(App_name)
        self.title_label.setFont(self.title_font)
        self.title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(self.title_label)

        layout.addStretch()
        #layout.addStretch()

        #Research button here.
        self.research_btn = QPushButton("Research")
        self.research_btn.setFont(self.button_font)
        self.research_btn.setIcon(self._create_research_icon())  # NEW ICON METHOD
        self.research_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        self.research_btn.setToolTip("Open Research Database (Ctrl+R)")
        self.research_btn.clicked.connect(self._on_research_clicked)
        layout.addWidget(self.research_btn)

        # Only show "Open IMG" button if NOT standalone
        if not self.standalone_mode:
            self.open_img_btn = QPushButton("OpenIMG")
            self.open_img_btn.setFont(self.button_font)
            self.open_img_btn.setIcon(self._create_folder_icon())
            self.open_img_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.open_img_btn.clicked.connect(self.open_img_archive)
            layout.addWidget(self.open_img_btn)

        # Open button
        self.open_btn = QPushButton()
        self.open_btn.setFont(self.button_font)
        self.open_btn.setIcon(self._create_open_icon())
        self.open_btn.setText("Open")
        self.open_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        self.open_btn.setShortcut("Ctrl+O")
        if self.button_display_mode == 'icons':
            self.open_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.open_btn.setToolTip("Open COL file (Ctrl+O)")
        self.open_btn.clicked.connect(self._open_file)
        layout.addWidget(self.open_btn)

        # Save button
        self.save_btn = QPushButton()
        self.save_btn.setFont(self.button_font)
        self.save_btn.setIcon(self._create_save_icon())
        self.save_btn.setText("Save")
        self.save_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        self.save_btn.setShortcut("Ctrl+S")
        if self.button_display_mode == 'icons':
            self.save_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.save_btn.setEnabled(False)  # Enable when modified
        self.save_btn.setToolTip("Save COL file (Ctrl+S)")
        self.save_btn.clicked.connect(self._save_file)
        layout.addWidget(self.save_btn)

        # Save button
        self.saveall_btn = QPushButton()
        self.saveall_btn.setFont(self.button_font)
        self.saveall_btn.setIcon(self._create_saveas_icon())
        self.saveall_btn.setText("Save All")
        self.saveall_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        self.saveall_btn.setShortcut("Ctrl+S")
        if self.button_display_mode == 'icons':
            self.saveall_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.saveall_btn.setEnabled(False)  # Enable when modified
        self.saveall_btn.setToolTip("Save COL file (Ctrl+S)")
        #self.saveall_btn.clicked.connect(self._saveall_file)
        #layout.addWidget(self.saveall_btn)

        self.export_all_btn = QPushButton("Extract")
        self.export_all_btn.setFont(self.button_font)
        self.export_all_btn.setIcon(self._create_package_icon())
        self.export_all_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.export_all_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.export_all_btn.setToolTip("Export all as ojs files")
        #self.export_all_btn.clicked.connect(self.export_all)
        self.export_all_btn.setEnabled(False)
        layout.addWidget(self.export_all_btn)

        self.undo_btn = QPushButton()
        self.undo_btn.setFont(self.button_font)
        self.undo_btn.setIcon(self._create_undo_icon())
        self.undo_btn.setText("Undo")
        self.undo_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.undo_btn.setFixedSize(self.iconsizex, self.iconsizey)

        #self.undo_btn.clicked.connect(self._undo_last_action)
        self.undo_btn.setEnabled(False)
        self.undo_btn.setToolTip("Undo last change")
        layout.addWidget(self.undo_btn)

        # Info button
        self.info_btn = QPushButton("")
        self.info_btn.setText("")  # CHANGED from "Info"
        self.info_btn.setIcon(self._create_info_icon())
        self.info_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        #self.info_btn.setMinimumHeight(30)
        self.info_btn.setToolTip("Information")
        self.info_btn.clicked.connect(self._show_about_dialog)
        self.layout.addWidget(self.info_btn)
        self.info_btn.setStyleSheet("""
            QPushButton {
                font-weight: bold;
                background-color: #4a4a4a;
                border: 1px solid #5a5a5a;
                border-radius: 3px;
            }
            QPushButton:hover {
                background-color: #5a5a5a;
            }
        """)
        self.info_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.info_btn.setFixedSize(self.iconsizex, self.iconsizey)

        #self.info_btn.clicked.connect(self._show_ojb_info)
        layout.addWidget(self.info_btn)

        # Properties/Theme button
        self.properties_btn = QPushButton()
        self.properties_btn.setFont(self.button_font)
        self.properties_btn.setIcon(ResBioSVGIcons.properties_icon(self.buticonsizex, icon_color))
        self.properties_btn.setToolTip("Theme")
        self.properties_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.properties_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.properties_btn.clicked.connect(self._show_settings_dialog)
        self.properties_btn.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.properties_btn.customContextMenuRequested.connect(self._show_settings_context_menu)
        layout.addWidget(self.properties_btn)

        # Dock button [D]
        self.dock_btn = QPushButton("D") #TODO needs to be a SVG icon
        #self.dock_btn.setFont(self.button_font)
        self.dock_btn.setMinimumWidth(self.gadiconsizex)
        self.dock_btn.setMaximumWidth(self.gadiconsizey)
        if self.dock_display_mode == 'icons':
            self.dock_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.dock_btn.setToolTip("Dock")
        self.dock_btn.setStyleSheet("""
            QPushButton {
                font-weight: bold;
                background-color: #4a4a4a;
                border: 1px solid #5a5a5a;
                border-radius: 3px;
            }
            QPushButton:hover {
                background-color: #5a5a5a;
            }
        """)
        self.dock_btn.clicked.connect(self.toggle_dock_mode)
        layout.addWidget(self.dock_btn)

                # Tear-off button [T] - only in IMG Factory mode
        if not self.standalone_mode:
            self.tearoff_btn = QPushButton("T") #TODO needs to be a SVG icon
            #self.tearoff_btn.setFont(self.button_font)
            self.tearoff_btn.setMinimumWidth(self.gadiconsizex)
            self.tearoff_btn.setMaximumWidth(self.gadiconsizey)
            self.tearoff_btn.clicked.connect(self._toggle_tearoff)
            self.tearoff_btn.setToolTip("TXD Workshop - Tearoff window")
            self.tearoff_btn.setStyleSheet("""
                QPushButton {
                    font-weight: bold;
                    background-color: #4a4a4a;
                    border: 1px solid #5a5a5a;
                    border-radius: 3px;
                }
                QPushButton:hover {
                    background-color: #5a5a5a;
                }
            """)
            layout.addWidget(self.tearoff_btn)

        # Window controls
        self.minimize_btn = QPushButton()
        self.minimize_btn.setIcon(self._create_minimize_icon())
        self.minimize_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.minimize_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.minimize_btn.setMinimumWidth(self.gadiconsizex)
        self.minimize_btn.setMaximumWidth(self.gadiconsizey)
        self.minimize_btn.clicked.connect(self.showMinimized)
        self.minimize_btn.setToolTip("Minimize Window") # click tab to restore
        layout.addWidget(self.minimize_btn)

        self.maximize_btn = QPushButton()
        self.maximize_btn.setIcon(self._create_maximize_icon())
        self.maximize_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.maximize_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.maximize_btn.setMinimumWidth(self.gadiconsizex)
        self.maximize_btn.setMaximumWidth(self.gadiconsizey)
        self.maximize_btn.clicked.connect(self._toggle_maximize)
        self.maximize_btn.setToolTip("Maximize/Restore Window")
        layout.addWidget(self.maximize_btn)

        self.close_btn = QPushButton()
        self.close_btn.setIcon(self._create_close_icon())
        self.close_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.close_btn.setFixedSize(self.iconsizex, self.iconsizey)

        self.close_btn.setMinimumWidth(self.gadiconsizex)
        self.close_btn.setMaximumWidth(self.gadiconsizey)
        self.close_btn.clicked.connect(self.close)
        self.close_btn.setToolTip("Close Window") # closes tab
        layout.addWidget(self.close_btn)

        return self.toolbar


    def _create_left_panel(self): #vers 5
        # Create left panel - COL file list (only in IMG Factory mode)
        # In standalone mode, don't create this panel
        if self.standalone_mode:
            self.col_list_widget = None  # Explicitly set to None
            return None

        if not self.main_window:
            # Standalone mode - return None to hide this panel
            return None

        # Only create panel in IMG Factory mode
        panel = QFrame()
        panel.setFrameStyle(QFrame.Shape.StyledPanel)
        panel.setMinimumWidth(200)
        panel.setMaximumWidth(300)

        layout = QVBoxLayout(panel)
        layout.setContentsMargins(*self.get_panel_margins())

        header = QLabel("Ojs Files")
        header.setFont(QFont("Arial", 10, QFont.Weight.Bold))
        layout.addWidget(header)

        self.col_list_widget = QListWidget()
        self.col_list_widget.setAlternatingRowColors(True)
        self.col_list_widget.itemClicked.connect(self._on_col_selected)
        layout.addWidget(self.col_list_widget)
        return panel

    def _create_middle_panel(self): #ver 1
        panel = QGroupBox()
        panel.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                font-size: 14px;
                border: 1px solid #3a3a3a;
                border-radius: 1px;
                margin-top: 10px;
                padding-top: 10px;
                background-color: #2b2b2b;
            }
        """)
        layout = QVBoxLayout(panel)
        self.middle_list = QTableWidget()
        self.middle_list.setColumnCount(2)
        self.middle_list.setHorizontalHeaderLabels(["Previewp", "Details"])
        self.middle_list.setSelectionBehavior(QAbstractItemView.SelectionBehavior.SelectRows)
        self.middle_list.setSelectionMode(QAbstractItemView.SelectionMode.SingleSelection)
        self.middle_list.setAlternatingRowColors(True)
        self.middle_list.setIconSize(QSize(self.iconsizex, self.iconsizey))
        self.middle_list.setColumnWidth(0, 100)
        self.middle_list.horizontalHeader().setStretchLastSection(True)
        layout.addWidget(self.middle_list)

        return panel

    def _create_right_panel(self): #vers 10
        #Create right panel with editing controls - compact layout
        panel = QFrame()
        panel.setFrameStyle(QFrame.Shape.StyledPanel)
        panel.setMinimumWidth(400)
        has_bumpmap = False
        main_layout = QVBoxLayout(panel)
        main_layout.setContentsMargins(*self.get_panel_margins())
        top_layout = QHBoxLayout()

        # Transform panel (left)
        transform_panel = self._create_transform_panel()
        top_layout.addWidget(transform_panel, stretch=1)


        # PREVIEW/DISPLAY AREA (Multi-view for text and game assets)
        display_group = QGroupBox("")
        display_group.setFont(self.title_font)
        display_layout = QVBoxLayout(display_group)
        display_layout.setContentsMargins(5, 5, 5, 5)

        # Display mode selector (top)
        mode_layout = QHBoxLayout()
        mode_label = QLabel("View:")
        mode_label.setFont(self.panel_font)
        mode_layout.addWidget(mode_label)

        self.display_mode_combo = QComboBox()
        self.display_mode_combo.setFont(self.panel_font)
        self.display_mode_combo.addItems(["Text", "3D Model", "Texture", "Collision", "Info"])
        self.display_mode_combo.setMaximumWidth(120)
        self.display_mode_combo.currentTextChanged.connect(self._on_display_mode_changed)
        mode_layout.addWidget(self.display_mode_combo)
        mode_layout.addStretch()

        display_layout.addLayout(mode_layout)

        # Multi-view display area
        self.display_stack = QStackedWidget()

        # === PAGE 0: Text Display (for research, docs, etc) ===
        text_display = QTextEdit()
        text_display.setReadOnly(True)
        text_display.setFont(QFont("Courier", 9))
        self.text_display = text_display
        self.display_stack.addWidget(text_display)

        # === PAGE 1: 3D Model Viewport (placeholder for now) ===
        model_display = QLabel("3D Model Viewer\n(Coming soon)")
        model_display.setAlignment(Qt.AlignmentFlag.AlignCenter)
        model_display.setStyleSheet("QLabel { background-color: #1a1a1a; color: #666; }")
        self.model_display = model_display
        self.display_stack.addWidget(model_display)

        # === PAGE 2: Texture Viewer (placeholder) ===
        texture_display = QLabel("Texture Viewer\n(Coming soon)")
        texture_display.setAlignment(Qt.AlignmentFlag.AlignCenter)
        texture_display.setStyleSheet("QLabel { background-color: #1a1a1a; color: #666; }")
        self.texture_display = texture_display
        self.display_stack.addWidget(texture_display)

        # === PAGE 3: Collision Viewer (placeholder) ===
        collision_display = QLabel("Collision Viewer\n(Coming soon)")
        collision_display.setAlignment(Qt.AlignmentFlag.AlignCenter)
        collision_display.setStyleSheet("QLabel { background-color: #1a1a1a; color: #666; }")
        self.collision_display = collision_display
        self.display_stack.addWidget(collision_display)

        # === PAGE 4: Info/Properties ===
        info_display = QLabel("Information Panel")
        info_display.setAlignment(Qt.AlignmentFlag.AlignCenter)
        info_display.setStyleSheet("QLabel { background-color: #1a1a1a; color: #666; }")
        self.info_display = info_display
        self.display_stack.addWidget(info_display)

        display_layout.addWidget(self.display_stack, stretch=1)

        main_layout.addWidget(display_group, stretch=1)

        # Information group below
        info_group = QGroupBox("")
        info_group.setFont(self.title_font)
        info_layout = QVBoxLayout(info_group)
        info_group.setMaximumHeight(140)

        # === LINE 1: collision name ===
        name_layout = QHBoxLayout()
        name_label = QLabel("Obj Name:")
        name_label.setFont(self.panel_font)
        name_layout.addWidget(name_label)

        self.info_name = QLineEdit()
        self.info_name.setText("Click to edit...")
        self.info_name.setFont(self.panel_font)
        self.info_name.setReadOnly(True)
        self.info_name.setStyleSheet("padding: px; border: 1px solid #3a3a3a;")
        #self.info_name.returnPressed.connect(self._save_surface_name)
        #self.info_name.editingFinished.connect(self._save_surface_name)
        self.info_name.mousePressEvent = lambda e: self._enable_name_edit(e, False)
        name_layout.addWidget(self.info_name, stretch=1)
        info_layout.addLayout(name_layout)

        # === LINES 2 & 3: Adaptive based on display mode ===
        if self.button_display_mode == 'icons':
            # MERGED: Single compact line for icon mode
            merged_line = self._create_merged_icons_line()
            info_layout.addLayout(merged_line)
        else:
            # SEPARATE: Original two-line layout for text/both modes
            # Line 2: Format controls
            format_layout = QHBoxLayout()
            format_layout.setSpacing(self.panelspacing)

            self.format_combo = QComboBox()
            self.format_combo.setFont(self.panel_font)
            self.format_combo.addItems(["ojb", "ojb2", "obj3", "obj4"])
            #self.format_combo.currentTextChanged.connect(self._change_format)
            self.format_combo.setEnabled(False)
            self.format_combo.setMaximumWidth(100)
            format_layout.addWidget(self.format_combo)

            format_layout.addStretch()

            # Switch button
            self.switch_btn = QPushButton("Switch")
            self.switch_btn.setFont(self.button_font)
            self.switch_btn.setIcon(self._create_flip_vert_icon())
            self.switch_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            #self.switch_btn.clicked.connect(self.switch_surface_view)
            self.switch_btn.setEnabled(False)
            self.switch_btn.setToolTip("Cycle: Wireframe → Mesh → Painted → Overlay")
            format_layout.addWidget(self.switch_btn)

            # Convert
            self.convert_btn = QPushButton("Convert")
            self.convert_btn.setFont(self.button_font)
            self.convert_btn.setIcon(self._create_convert_icon())
            self.convert_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.convert_btn.setToolTip("Convert Collision format")
            #self.convert_btn.clicked.connect(self._convert_surface)
            self.convert_btn.setEnabled(False)
            format_layout.addWidget(self.convert_btn)

            # Line 3: shadow + Bumpmaps
            mipbump_layout = QHBoxLayout()
            mipbump_layout.setSpacing(self.panelspacing)

            self.info_format = QLabel("Example: ")
            self.info_format.setFont(self.panel_font)
            self.info_format.setMinimumWidth(100)
            mipbump_layout.addWidget(self.info_format)

            self.show_shadow_btn = QPushButton("View")
            self.show_shadow_btn.setFont(self.button_font)
            self.show_shadow_btn.setIcon(self._create_view_icon())
            self.show_shadow_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.show_shadow_btn.setToolTip("View all levels")
            #self.show_shadow_btn.clicked.connect(self._open_mipmap_manager)
            self.show_shadow_btn.setEnabled(False)
            mipbump_layout.addWidget(self.show_shadow_btn)

            self.create_shadow_btn = QPushButton("Create")
            self.create_shadow_btn.setFont(self.button_font)
            self.create_shadow_btn.setIcon(self._create_add_icon())
            self.create_shadow_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.create_shadow_btn.setToolTip("Generate Shadow Mesh")
            #self.create_shadow_btn.clicked.connect(self._create_shadow_dialog)
            self.create_shadow_btn.setEnabled(False)
            mipbump_layout.addWidget(self.create_shadow_btn)

            self.remove_shadow_btn = QPushButton("Remove")
            self.remove_shadow_btn.setFont(self.button_font)
            self.remove_shadow_btn.setIcon(self._create_delete_icon())
            self.remove_shadow_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.remove_shadow_btn.setToolTip("Remove Shodow Mesh")
            #self.remove_shadow_btn.clicked.connect(self._remove_shadow)
            self.remove_shadow_btn.setEnabled(False)
            mipbump_layout.addWidget(self.remove_shadow_btn)

            mipbump_layout.addSpacing(self.panelspacing)
            view_layout = QHBoxLayout()

            self.compress_btn = QPushButton("Compress")
            self.compress_btn.setFont(self.button_font)
            self.compress_btn.setIcon(self._create_compress_icon())
            self.compress_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.compress_btn.setToolTip("Compress Collision")
            #self.compress_btn.clicked.connect(self._compress_surface)
            self.compress_btn.setEnabled(False)
            format_layout.addWidget(self.compress_btn)

            self.uncompress_btn = QPushButton("Uncompress")
            self.uncompress_btn.setFont(self.button_font)
            self.uncompress_btn.setIcon(self._create_uncompress_icon())
            self.uncompress_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.uncompress_btn.setToolTip("Uncompress Collision")
            #self.uncompress_btn.clicked.connect(self._uncompress_surface)
            self.uncompress_btn.setEnabled(False)
            format_layout.addWidget(self.uncompress_btn)

            self.import_btn = QPushButton("Import")
            self.import_btn.setFont(self.button_font)
            self.import_btn.setIcon(self._create_import_icon())
            self.import_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.import_btn.setToolTip("Import col, cst, 3ds files")
            #self.import_btn.clicked.connect(self._import_selected)
            self.import_btn.setEnabled(False)
            format_layout.addWidget(self.import_btn)

            self.export_btn = QPushButton("Export")
            self.export_btn.setFont(self.button_font)
            self.export_btn.setIcon(self._create_export_icon())
            self.export_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
            self.export_btn.setToolTip("Export col, cst, 3ds files")
            #self.export_btn.clicked.connect(self.export_selected)
            self.export_btn.setEnabled(False)
            format_layout.addWidget(self.export_btn)

            info_layout.addLayout(format_layout)
            info_layout.addLayout(view_layout)
            info_layout.addLayout(mipbump_layout)

        main_layout.addWidget(info_group, stretch=0)
        return panel


    def _create_transform_panel(self): #vers 1
        #Create transform panel with variable width - no headers
        self.transform_panel = QFrame()
        self.transform_panel.setFrameStyle(QFrame.Shape.StyledPanel)
        self.transform_panel.setMinimumWidth(30)
        self.transform_panel.setMaximumWidth(200)
        if self.button_display_mode == 'icons':
            self.transform_panel.setMaximumWidth(self.transframewidth)
            self.transform_panel.setMinimumWidth(self.transframewidth)
            layout.addSpacing(self.ctrispacing)

        layout = QVBoxLayout(self.transform_panel)
        layout.setContentsMargins(*self.get_ctrl_margins())
        layout.setSpacing(self.ctrispacing)

        # Flip Vertical
        self.flip_vert_btn = QPushButton()
        self.flip_vert_btn.setFont(self.button_font)
        self.flip_vert_btn.setIcon(self._create_flip_vert_icon())
        self.flip_vert_btn.setText("Flip Vertical")
        self.flip_vert_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.flip_vert_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.flip_vert_btn.clicked.connect(self._flip_vertical)
        self.flip_vert_btn.setEnabled(False)
        self.flip_vert_btn.setToolTip("Flip col vertically")
        layout.addWidget(self.flip_vert_btn)

        # Flip Horizontal
        self.flip_horz_btn = QPushButton()
        self.flip_horz_btn.setFont(self.button_font)
        self.flip_horz_btn.setIcon(self._create_flip_horz_icon())
        self.flip_horz_btn.setText("Flip Horizontal")
        self.flip_horz_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.flip_horz_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.flip_horz_btn.clicked.connect(self._flip_horizontal)
        self.flip_horz_btn.setEnabled(False)
        self.flip_horz_btn.setToolTip("Flip col horizontally")
        layout.addWidget(self.flip_horz_btn)

        layout.addSpacing(self.ctrispacing)

        # Rotate Clockwise
        self.rotate_cw_btn = QPushButton()
        self.rotate_cw_btn.setFont(self.button_font)
        self.rotate_cw_btn.setIcon(self._create_rotate_cw_icon())
        self.rotate_cw_btn.setText("Rotate 90° CW")
        self.rotate_cw_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.rotate_cw_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.rotate_cw_btn.clicked.connect(self._rotate_clockwise)
        self.rotate_cw_btn.setEnabled(False)
        self.rotate_cw_btn.setToolTip("Rotate 90 degrees clockwise")
        layout.addWidget(self.rotate_cw_btn)

        # Rotate Counter-Clockwise
        self.rotate_ccw_btn = QPushButton()
        self.rotate_ccw_btn.setFont(self.button_font)
        self.rotate_ccw_btn.setIcon(self._create_rotate_ccw_icon())
        self.rotate_ccw_btn.setText("Rotate 90° CCW")
        self.rotate_ccw_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.rotate_ccw_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.rotate_ccw_btn.clicked.connect(self._rotate_counterclockwise)
        self.rotate_ccw_btn.setEnabled(False)
        self.rotate_ccw_btn.setToolTip("Rotate 90 degrees counter-clockwise")
        layout.addWidget(self.rotate_ccw_btn)

        layout.addSpacing(self.ctrispacing)

        # Analyze button
        self.analyze_btn = QPushButton()
        self.analyze_btn.setFont(self.button_font)
        self.analyze_btn.setIcon(self._create_analyze_icon())
        self.analyze_btn.setText("Analyze")
        self.analyze_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.analyze_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.analyze_btn.clicked.connect(self._analyze_collision)
        self.analyze_btn.setEnabled(False)  # Enable when COL loaded
        self.analyze_btn.setToolTip("Analyze collision data")
        layout.addWidget(self.analyze_btn)

        layout.addStretch()

        # Copy
        self.copy_btn = QPushButton()
        self.copy_btn.setFont(self.button_font)
        self.copy_btn.setIcon(self._create_copy_icon())
        self.copy_btn.setText("Copy")
        self.copy_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.copy_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.copy_btn.clicked.connect(self._copy_surface)
        self.copy_btn.setEnabled(False)
        self.copy_btn.setToolTip("Copy col to clipboard")
        layout.addWidget(self.copy_btn)

        # Paste
        self.paste_btn = QPushButton()
        self.paste_btn.setFont(self.button_font)
        self.paste_btn.setIcon(self._create_paste_icon())
        self.paste_btn.setText("Paste")
        self.paste_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.paste_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.paste_btn.clicked.connect(self._paste_surface)
        self.paste_btn.setEnabled(False)
        self.paste_btn.setToolTip("Paste col from clipboard")
        layout.addWidget(self.paste_btn)

        # Create Collision
        self.create_surface_btn = QPushButton()
        self.create_surface_btn.setFont(self.button_font)
        self.create_surface_btn.setIcon(self._create_create_icon())
        self.create_surface_btn.setText("Create")
        self.create_surface_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.create_surface_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.create_surface_btn.clicked.connect(self._create_new_surface_entry)
        self.create_surface_btn.setToolTip("Create new blank Collision")
        layout.addWidget(self.create_surface_btn)

        # Delete collision
        self.delete_surface_btn = QPushButton()
        self.delete_surface_btn.setFont(self.button_font)
        self.delete_surface_btn.setIcon(self._create_delete_icon())
        self.delete_surface_btn.setText("Delete")
        self.delete_surface_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.delete_surface_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.delete_surface_btn.clicked.connect(self._delete_surface)
        self.delete_surface_btn.setEnabled(False)
        self.delete_surface_btn.setToolTip("Remove selected Collision")
        layout.addWidget(self.delete_surface_btn)

        # Duplicate Collision
        self.duplicate_surface_btn = QPushButton()
        self.duplicate_surface_btn.setFont(self.button_font)
        self.duplicate_surface_btn.setIcon(self._create_duplicate_icon())
        self.duplicate_surface_btn.setText("Duplicate")
        self.duplicate_surface_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.duplicate_surface_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.duplicate_surface_btn.clicked.connect(self._duplicate_surface)
        self.duplicate_surface_btn.setEnabled(False)
        self.duplicate_surface_btn.setToolTip("Clone selected Collision")
        layout.addWidget(self.duplicate_surface_btn)

        self.paint_btn = QPushButton()
        self.paint_btn.setFont(self.button_font)
        self.paint_btn.setIcon(self._create_paint_icon())
        self.paint_btn.setText("Paint")
        self.paint_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.paint_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.paint_btn.clicked.connect(self._open_paint_editor)
        self.paint_btn.setEnabled(False)
        self.paint_btn.setToolTip("Paint free hand on surface")
        layout.addWidget(self.paint_btn)

        layout.addSpacing(self.ctrispacing)

        # Check col vs DFF
        self.surface_type_btn = QPushButton()
        self.surface_type_btn.setFont(self.button_font)
        self.surface_type_btn.setIcon(self._create_check_icon())
        self.surface_type_btn.setText("Surface type")
        self.surface_type_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.surface_type_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.surface_type_btn.clicked.connect(self._check_col_type)
        self.surface_type_btn.setToolTip("Surface types")
        layout.addWidget(self.surface_type_btn)

        # Check col vs DFF
        self.surface_edit_btn = QPushButton()
        self.surface_edit_btn.setFont(self.button_font)
        self.surface_edit_btn.setIcon(self._create_check_icon())
        self.surface_edit_btn.setText("Surface Edit")
        self.surface_edit_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.surface_edit_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.surface_type_btn.clicked.connect(self._col_edit)
        self.surface_edit_btn.setToolTip("Surface Editor")
        layout.addWidget(self.surface_edit_btn)

        self.build_from_txd_btn = QPushButton()
        self.build_from_txd_btn.setFont(self.button_font)
        self.build_from_txd_btn.setIcon(self._create_build_icon())
        self.build_from_txd_btn.setText("Build col via")
        self.build_from_txd_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        if self.button_display_mode == 'icons':
            self.build_from_txd_btn.setIconSize(QSize(self.iconsizex, self.iconsizey))
        #self.build_from_dff_btn.clicked.connect(self._build_col_from_dff)
        self.build_from_txd_btn.setToolTip("Create col surface from txd texture names")
        layout.addWidget(self.build_from_txd_btn)

        layout.addSpacing(self.ctrispacing)

        layout.addStretch()

        return self.transform_panel


    def _create_preview_controls(self): #vers 5
        """Create preview control buttons - vertical layout on right"""
        controls_frame = QFrame()
        controls_frame.setFrameStyle(QFrame.Shape.StyledPanel)
        controls_frame.setMaximumWidth(50)
        controls_layout = QVBoxLayout(controls_frame)
        controls_layout.setContentsMargins(*self.get_ctrl_margins())
        controls_layout.setSpacing(self.panelspacing)

        # Check if using 3D viewport or 2D preview
        #is_3d_viewport = VIEWPORT_AVAILABLE and isinstance(self.preview_widget, COL3DViewport)

        # Zoom In
        zoom_in_btn = QPushButton()
        zoom_in_btn.setIcon(self._create_zoom_in_icon())
        zoom_in_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        zoom_in_btn.setFixedSize(self.previframewidth, self.previframeheight)
        zoom_in_btn.setToolTip("Zoom In")
        #zoom_in_btn.clicked.connect(self.preview_widget.zoom_in)
        controls_layout.addWidget(zoom_in_btn)

        # Zoom Out
        zoom_out_btn = QPushButton()
        zoom_out_btn.setIcon(self._create_zoom_out_icon())
        zoom_out_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        zoom_out_btn.setFixedSize(self.previframewidth, self.previframeheight)
        zoom_out_btn.setToolTip("Zoom Out")
        #zoom_out_btn.clicked.connect(self.preview_widget.zoom_out)
        controls_layout.addWidget(zoom_out_btn)

        # Reset
        reset_btn = QPushButton()
        reset_btn.setIcon(self._create_reset_icon())
        reset_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        reset_btn.setFixedSize(self.previframewidth, self.previframeheight)
        reset_btn.setToolTip("Reset View")
        #reset_btn.clicked.connect(self.preview_widget.reset_view)
        controls_layout.addWidget(reset_btn)

        # Fit
        fit_btn = QPushButton()
        fit_btn.setIcon(self._create_fit_icon())
        fit_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        fit_btn.setFixedSize(self.previframewidth, self.previframeheight)
        fit_btn.setToolTip("Fit to Window")
        #fit_btn.clicked.connect(self.preview_widget.fit_to_window)
        controls_layout.addWidget(fit_btn)

        controls_layout.addSpacing(self.panelspacing)

        # Pan Up
        pan_up_btn = QPushButton()
        pan_up_btn.setIcon(self._create_arrow_up_icon())
        pan_up_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        pan_up_btn.setFixedSize(self.previframewidth, self.previframeheight)
        pan_up_btn.setToolTip("Pan Up")
        #pan_up_btn.clicked.connect(lambda: self._pan_preview(0, -20))
        controls_layout.addWidget(pan_up_btn)

        # Pan Down
        pan_down_btn = QPushButton()
        pan_down_btn.setIcon(self._create_arrow_down_icon())
        pan_down_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        pan_down_btn.setFixedSize(self.previframewidth, self.previframeheight)
        pan_down_btn.setToolTip("Pan Down")
        #pan_down_btn.clicked.connect(lambda: self._pan_preview(0, 20))
        controls_layout.addWidget(pan_down_btn)

        # Pan Left
        pan_left_btn = QPushButton()
        pan_left_btn.setIcon(self._create_arrow_left_icon())
        pan_left_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        pan_left_btn.setFixedSize(self.previframewidth, self.previframeheight)
        pan_left_btn.setToolTip("Pan Left")
        #pan_left_btn.clicked.connect(lambda: self._pan_preview(-20, 0))
        controls_layout.addWidget(pan_left_btn)

        # Pan Right
        pan_right_btn = QPushButton()
        pan_right_btn.setIcon(self._create_arrow_right_icon())
        pan_right_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        pan_right_btn.setFixedSize(self.previframewidth, self.previframeheight)
        pan_right_btn.setToolTip("Pan Right")
        #pan_right_btn.clicked.connect(lambda: self._pan_preview(20, 0))
        controls_layout.addWidget(pan_right_btn)

        # Color picker
        bg_custom_btn = QPushButton()
        bg_custom_btn.setIcon(self._create_color_picker_icon())
        bg_custom_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        bg_custom_btn.setFixedSize(self.previframewidth, self.previframeheight)
        bg_custom_btn.setToolTip("Pick Background Color")
        #bg_custom_btn.clicked.connect(self._pick_background_color)
        controls_layout.addWidget(bg_custom_btn)

        controls_layout.addSpacing(self.panelspacing)

        # View Spheres toggle
        self.view_spheres_btn = QPushButton()
        self.view_spheres_btn.setIcon(self._create_sphere_icon())
        self.view_spheres_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        self.view_spheres_btn.setFixedSize(self.previframewidth, self.previframeheight)
        self.view_spheres_btn.setCheckable(True)
        self.view_spheres_btn.setChecked(True)
        self.view_spheres_btn.setToolTip("Toggle Spheres")
        #self.view_spheres_btn.clicked.connect(self._toggle_spheres)
        controls_layout.addWidget(self.view_spheres_btn)

        # View Boxes toggle
        self.view_boxes_btn = QPushButton()
        self.view_boxes_btn.setIcon(self._create_box_icon())
        self.view_boxes_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        self.view_boxes_btn.setFixedSize(self.previframewidth, self.previframeheight)
        self.view_boxes_btn.setCheckable(True)
        self.view_boxes_btn.setChecked(True)
        self.view_boxes_btn.setToolTip("Toggle Boxes")
        #self.view_boxes_btn.clicked.connect(self._toggle_boxes)
        controls_layout.addWidget(self.view_boxes_btn)

        # View Mesh toggle
        self.view_mesh_btn = QPushButton()
        self.view_mesh_btn.setIcon(self._create_mesh_icon())
        self.view_mesh_btn.setIconSize(QSize(self.buticonsizex, self.buticonsizey))
        self.view_mesh_btn.setFixedSize(self.previframewidth, self.previframeheight)
        self.view_mesh_btn.setCheckable(True)
        self.view_mesh_btn.setChecked(True)
        self.view_mesh_btn.setToolTip("Toggle Mesh")
        #self.view_mesh_btn.clicked.connect(self._toggle_mesh)
        controls_layout.addWidget(self.view_mesh_btn)
        controls_layout.addSpacing(self.panelspacing)

        return controls_frame

    def _create_status_bar(self): #vers 1
        from PyQt6.QtWidgets import QFrame, QHBoxLayout, QLabel

        status_bar = QFrame()
        status_bar.setFrameStyle(QFrame.Shape.StyledPanel | QFrame.Shadow.Sunken)
        status_bar.setFixedHeight(self.statusheight)

        layout = QHBoxLayout(status_bar)
        layout.setContentsMargins(*self.get_tab_margins())
        layout.setSpacing(self.tabbarspacing)

        # Left: Ready
        self.status_label = QLabel("Ready")
        layout.addWidget(self.status_label)

        if hasattr(self, 'status_info'):
            size_kb = len(col_data) / 1024
            obj_count = len(self.object_list)
            #self.status_ojs_info.setText(f"Object: {obj_count} | obj: {size_kb:.1f} KB")

        return status_bar


    def _on_display_mode_changed(self, mode): #vers 1
        """Handle display mode change"""
        modes = {
            "Text": 0,
            "3D Model": 1,
            "Texture": 2,
            "Collision": 3,
            "Info": 4
        }
        if mode in modes:
            self.display_stack.setCurrentIndex(modes[mode])
            img_debugger.debug(f"Display mode changed to: {mode}")

    def show_research_content(self, content_text): #vers 1
        """Display research/text content in text viewer"""
        if hasattr(self, 'text_display'):
            self.text_display.setText(content_text)
            self.display_mode_combo.setCurrentIndex(0)  # Switch to Text mode
            img_debugger.debug("Research content displayed")

    def show_3d_model(self, model_data): #vers 1
        """Display 3D model (placeholder for future implementation)"""
        if hasattr(self, 'model_display'):
            self.display_mode_combo.setCurrentIndex(1)  # Switch to 3D mode
            img_debugger.debug("Model viewer activated")

    def show_texture(self, texture_data): #vers 1
        """Display texture (placeholder for future implementation)"""
        if hasattr(self, 'texture_display'):
            self.display_mode_combo.setCurrentIndex(2)  # Switch to Texture mode
            img_debugger.debug("Texture viewer activated")

    def show_collision(self, collision_data): #vers 1
        """Display collision data (placeholder for future implementation)"""
        if hasattr(self, 'collision_display'):
            self.display_mode_combo.setCurrentIndex(3)  # Switch to Collision mode
            img_debugger.debug("Collision viewer activated")

    def clear_display(self): #vers 1
        """Clear all display content"""
        if hasattr(self, 'text_display'):
            self.text_display.setText("")

# - Fonts settings

    def _apply_title_font(self): #vers 1
        """Apply title font to title bar labels"""
        if hasattr(self, 'title_font'):
            # Find all title labels
            for label in self.findChildren(QLabel):
                if label.objectName() == "title_label" or "🗺️" in label.text():
                    label.setFont(self.title_font)


    def _apply_panel_font(self): #vers 1
        """Apply panel font to info panels and labels"""
        if hasattr(self, 'panel_font'):
            # Apply to info labels (Mipmaps, Bumpmaps, status labels)
            for label in self.findChildren(QLabel):
                if any(x in label.text() for x in ["Mipmaps:", "Bumpmaps:", "Status:", "Type:", "Format:"]):
                    label.setFont(self.panel_font)


    def _apply_button_font(self): #vers 1
        """Apply button font to all buttons"""
        if hasattr(self, 'button_font'):
            for button in self.findChildren(QPushButton):
                button.setFont(self.button_font)


    def _apply_infobar_font(self): #vers 1
        """Apply fixed-width font to info bar at bottom"""
        if hasattr(self, 'infobar_font'):
            if hasattr(self, 'info_bar'):
                self.info_bar.setFont(self.infobar_font)

# - Save, Load config dialogs

    def _open_settings_dialog(self): #vers 1
        """Open settings dialog and refresh on save"""
        dialog = SettingsDialog(self.mel_settings, self)
        if dialog.exec():
            # Refresh platform list with new ROM path
            self._scan_platforms()
            self.status_label.setText("Settings saved - platforms refreshed")


    def _setup_settings_button(self): #vers 1
        """Setup settings button in UI"""
        settings_btn = QPushButton("âš™ Settings")
        settings_btn.clicked.connect(self._open_settings_dialog)
        settings_btn.setMaximumWidth(120)
        return settings_btn


    def _show_settings_dialog(self): #vers 6
        """Show settings dialog - tries app_settings_system.py first, falls back to built-in"""
        try:
            # Try to import from apps/utils/app_settings_system.py
            from apps.utils.app_settings_system import AppSettings, SettingsDialog
            
            # Load AppSettings
            if not hasattr(self, 'app_settings'):
                self.app_settings = AppSettings()
            
            # Show the full SettingsDialog from app_settings_system
            dialog = SettingsDialog(self.app_settings, self)
            if dialog.exec():
                # Apply settings and refresh UI
                self._on_theme_changed()
                if self.main_window and hasattr(self.main_window, 'log_message'):
                    self.main_window.log_message("Settings saved and applied")
            return
            
        except ImportError:
            # Fallback: Use built-in settings dialog
            print("WARNING: app_settings_system.py not found, using fallback settings dialog")
            self._show_settings_dialog_fallback()
    def _show_settings_dialog_fallback(self): #vers 1
        """Fallback built-in settings dialog (basic display/preview settings)"""
        from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QTabWidget,
                                    QWidget, QLabel, QPushButton, QGroupBox,
                                    QCheckBox, QSpinBox, QFormLayout, QScrollArea,
                                    QComboBox, QMessageBox)
        from PyQt6.QtCore import Qt
        from PyQt6.QtGui import QKeySequence

        dialog = QDialog(self)
        dialog.setWindowTitle(App_name + " Settings (Fallback)")
        dialog.setMinimumWidth(700)
        dialog.setMinimumHeight(600)

        layout = QVBoxLayout(dialog)
        tabs = QTabWidget()

        # === DISPLAY TAB ===
        display_tab = QWidget()
        display_layout = QVBoxLayout(display_tab)

        thumb_group = QGroupBox("Thumbnail Display")
        thumb_layout = QVBoxLayout()
        thumb_size_layout = QHBoxLayout()
        thumb_size_layout.addWidget(QLabel("Thumbnail size:"))
        thumb_size_spin = QSpinBox()
        thumb_size_spin.setRange(32, 256)
        thumb_size_spin.setValue(self.thumbnail_size if hasattr(self, 'thumbnail_size') else 64)
        thumb_size_spin.setSuffix(" px")
        thumb_size_layout.addWidget(thumb_size_spin)
        thumb_size_layout.addStretch()
        thumb_layout.addLayout(thumb_size_layout)
        thumb_group.setLayout(thumb_layout)
        display_layout.addWidget(thumb_group)

        table_group = QGroupBox("Table Display")
        table_layout = QVBoxLayout()
        row_height_layout = QHBoxLayout()
        row_height_layout.addWidget(QLabel("Row height:"))
        row_height_spin = QSpinBox()
        row_height_spin.setRange(50, 200)
        row_height_spin.setValue(getattr(self, 'table_row_height', 100))
        row_height_spin.setSuffix(" px")
        row_height_layout.addWidget(row_height_spin)
        row_height_layout.addStretch()
        table_layout.addLayout(row_height_layout)
        table_group.setLayout(table_layout)
        display_layout.addWidget(table_group)

        display_layout.addStretch()
        tabs.addTab(display_tab, "Display")

        # === PREVIEW TAB ===
        preview_tab = QWidget()
        preview_layout = QVBoxLayout(preview_tab)
        show_preview_check = QCheckBox("Show preview by default")
        show_preview_check.setChecked(getattr(self, 'show_preview_default', True))
        preview_layout.addWidget(show_preview_check)

        auto_refresh_check = QCheckBox("Auto-refresh preview")
        auto_refresh_check.setChecked(getattr(self, 'auto_refresh_preview', True))
        preview_layout.addWidget(auto_refresh_check)

        preview_layout.addStretch()
        tabs.addTab(preview_tab, "Preview")

        layout.addWidget(tabs)

        # BUTTONS
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()

        def apply_settings(close_dialog=False):
            self.thumbnail_size = thumb_size_spin.value()
            self.table_row_height = row_height_spin.value()
            self.show_preview_default = show_preview_check.isChecked()
            self.auto_refresh_preview = auto_refresh_check.isChecked()
            
            if hasattr(self, '_reload_surface_table'):
                self._reload_surface_table()
            
            if self.main_window and hasattr(self.main_window, 'log_message'):
                self.main_window.log_message("Settings applied")
            
            if close_dialog:
                dialog.accept()

        apply_btn = QPushButton("Apply")
        apply_btn.clicked.connect(lambda: apply_settings(close_dialog=False))
        btn_layout.addWidget(apply_btn)

        ok_btn = QPushButton("OK")
        ok_btn.setDefault(True)
        ok_btn.clicked.connect(lambda: apply_settings(close_dialog=True))
        btn_layout.addWidget(ok_btn)

        cancel_btn = QPushButton("Cancel")
        cancel_btn.clicked.connect(dialog.reject)
        btn_layout.addWidget(cancel_btn)

        layout.addLayout(btn_layout)
        dialog.exec()


    def _show_settings_context_menu(self, pos): #vers 1
        """Show context menu for Settings button"""
        from PyQt6.QtWidgets import QMenu

        menu = QMenu(self)

        # Move window action
        move_action = menu.addAction("Move Window")
        move_action.triggered.connect(self._enable_move_mode)

        # Maximize window action
        max_action = menu.addAction("Maximize Window")
        max_action.triggered.connect(self._toggle_maximize)

        # Minimize action
        min_action = menu.addAction("Minimize")
        min_action.triggered.connect(self.showMinimized)

        menu.addSeparator()

        # Upscale Native action
        upscale_action = menu.addAction("Upscale Native")
        upscale_action.setCheckable(True)
        upscale_action.setChecked(False)
        upscale_action.triggered.connect(self._toggle_upscale_native)

        # Shaders action
        shaders_action = menu.addAction("Shaders")
        shaders_action.triggered.connect(self._show_shaders_dialog)

        menu.addSeparator()

        # Icon display mode submenu # TODO icon only system is missing.
        display_menu = menu.addMenu("Platform Display")

        icons_text_action = display_menu.addAction("Icons & Text")
        icons_text_action.setCheckable(True)
        icons_text_action.setChecked(self.icon_display_mode == "icons_and_text")
        icons_text_action.triggered.connect(lambda: self._set_icon_display_mode("icons_and_text"))

        icons_only_action = display_menu.addAction("Icons Only")
        icons_only_action.setCheckable(True)
        icons_only_action.setChecked(self.icon_display_mode == "icons_only")
        icons_only_action.triggered.connect(lambda: self._set_icon_display_mode("icons_only"))

        text_only_action = display_menu.addAction("Text Only")
        text_only_action.setCheckable(True)
        text_only_action.setChecked(self.icon_display_mode == "text_only")
        text_only_action.triggered.connect(lambda: self._set_icon_display_mode("text_only"))

        # Show menu at button position
        menu.exec(self.settings_btn.mapToGlobal(pos))


# - Panel settings

    def _show_workshop_settings(self): #vers 1
        #Show complete workshop settings dialog
        from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QPushButton,
                                    QTabWidget, QWidget, QGroupBox, QFormLayout,
                                    QSpinBox, QComboBox, QSlider, QLabel, QCheckBox,
                                    QFontComboBox)
        from PyQt6.QtCore import Qt
        from PyQt6.QtGui import QFont

        dialog = QDialog(self)
        dialog.setWindowTitle(App_name + "Settings")
        dialog.setMinimumWidth(650)
        dialog.setMinimumHeight(550)

        layout = QVBoxLayout(dialog)

        # Create tabs
        tabs = QTabWidget()

        # TAB 1: FONTS (FIRST TAB)

        fonts_tab = QWidget()
        fonts_layout = QVBoxLayout(fonts_tab)

        # Default Font
        default_font_group = QGroupBox("Default Font")
        default_font_layout = QHBoxLayout()

        default_font_combo = QFontComboBox()
        default_font_combo.setCurrentFont(self.font())
        default_font_layout.addWidget(default_font_combo)

        default_font_size = QSpinBox()
        default_font_size.setRange(8, 24)
        default_font_size.setValue(self.font().pointSize())
        default_font_size.setSuffix(" pt")
        default_font_size.setFixedWidth(80)
        default_font_layout.addWidget(default_font_size)

        default_font_group.setLayout(default_font_layout)
        fonts_layout.addWidget(default_font_group)

        # Title Font
        title_font_group = QGroupBox("Title Font")
        title_font_layout = QHBoxLayout()

        title_font_combo = QFontComboBox()

        if hasattr(self, 'title_font'):
            title_font_combo.setCurrentFont(self.title_font)
        else:
            title_font_combo.setCurrentFont(QFont("Arial", 14))
        title_font_layout.addWidget(title_font_combo)

        title_font_size = QSpinBox()
        title_font_size.setRange(10, 32)
        title_font_size.setValue(getattr(self, 'title_font', QFont("Arial", 14)).pointSize())
        title_font_size.setSuffix(" pt")
        title_font_size.setFixedWidth(80)
        title_font_layout.addWidget(title_font_size)

        title_font_group.setLayout(title_font_layout)
        fonts_layout.addWidget(title_font_group)

        # Panel Font
        panel_font_group = QGroupBox("Panel Headers Font")
        panel_font_layout = QHBoxLayout()

        panel_font_combo = QFontComboBox()
        if hasattr(self, 'panel_font'):
            panel_font_combo.setCurrentFont(self.panel_font)
        else:
            panel_font_combo.setCurrentFont(QFont("Arial", 10))
        panel_font_layout.addWidget(panel_font_combo)

        panel_font_size = QSpinBox()
        panel_font_size.setRange(8, 18)
        panel_font_size.setValue(getattr(self, 'panel_font', QFont("Arial", 10)).pointSize())
        panel_font_size.setSuffix(" pt")
        panel_font_size.setFixedWidth(80)
        panel_font_layout.addWidget(panel_font_size)

        panel_font_group.setLayout(panel_font_layout)
        fonts_layout.addWidget(panel_font_group)

        # Button Font
        button_font_group = QGroupBox("Button Font")
        button_font_layout = QHBoxLayout()

        button_font_combo = QFontComboBox()
        if hasattr(self, 'button_font'):
            button_font_combo.setCurrentFont(self.button_font)
        else:
            button_font_combo.setCurrentFont(QFont("Arial", 10))
        button_font_layout.addWidget(button_font_combo)

        button_font_size = QSpinBox()
        button_font_size.setRange(8, 16)
        button_font_size.setValue(getattr(self, 'button_font', QFont("Arial", 10)).pointSize())
        button_font_size.setSuffix(" pt")
        button_font_size.setFixedWidth(80)
        button_font_layout.addWidget(button_font_size)

        button_font_group.setLayout(button_font_layout)
        fonts_layout.addWidget(button_font_group)

        # Info Bar Font
        infobar_font_group = QGroupBox("Info Bar Font")
        infobar_font_layout = QHBoxLayout()

        infobar_font_combo = QFontComboBox()
        if hasattr(self, 'infobar_font'):
            infobar_font_combo.setCurrentFont(self.infobar_font)
        else:
            infobar_font_combo.setCurrentFont(QFont("Courier New", 9))
        infobar_font_layout.addWidget(infobar_font_combo)

        infobar_font_size = QSpinBox()
        infobar_font_size.setRange(7, 14)
        infobar_font_size.setValue(getattr(self, 'infobar_font', QFont("Courier New", 9)).pointSize())
        infobar_font_size.setSuffix(" pt")
        infobar_font_size.setFixedWidth(80)
        infobar_font_layout.addWidget(infobar_font_size)

        infobar_font_group.setLayout(infobar_font_layout)
        fonts_layout.addWidget(infobar_font_group)

        fonts_layout.addStretch()
        tabs.addTab(fonts_tab, "Fonts")

        # TAB 2: DISPLAY SETTINGS

        display_tab = QWidget()
        display_layout = QVBoxLayout(display_tab)

        # Button display mode
        button_group = QGroupBox("Button Display Mode")
        button_layout = QVBoxLayout()

        button_mode_combo = QComboBox()
        button_mode_combo.addItems(["Icons + Text", "Icons Only", "Text Only"])
        current_mode = getattr(self, 'button_display_mode', 'both')
        mode_map = {'both': 0, 'icons': 1, 'text': 2}
        button_mode_combo.setCurrentIndex(mode_map.get(current_mode, 0))
        button_layout.addWidget(button_mode_combo)

        button_hint = QLabel("Changes how toolbar buttons are displayed")
        button_hint.setStyleSheet("color: #888; font-style: italic;")
        button_layout.addWidget(button_hint)

        button_group.setLayout(button_layout)
        display_layout.addWidget(button_group)

        # Table display
        table_group = QGroupBox("Surface List Display")
        table_layout = QVBoxLayout()

        show_thumbnails = QCheckBox("Show Surface types")
        show_thumbnails.setChecked(True)
        table_layout.addWidget(show_thumbnails)

        show_warnings = QCheckBox("Show warning icons for suspicious files")
        show_warnings.setChecked(True)
        show_warnings.setToolTip("Shows surface types")
        table_layout.addWidget(show_warnings)

        table_group.setLayout(table_layout)
        display_layout.addWidget(table_group)

        display_layout.addStretch()
        tabs.addTab(display_tab, "Display")

        # TAB 3: placeholder
        # TAB 4: PERFORMANCE

        perf_tab = QWidget()
        perf_layout = QVBoxLayout(perf_tab)

        perf_group = QGroupBox("Performance Settings")
        perf_form = QFormLayout()

        preview_quality = QComboBox()
        preview_quality.addItems(["Low (Fast)", "Medium", "High (Slow)"])
        preview_quality.setCurrentIndex(1)
        perf_form.addRow("Preview Quality:", preview_quality)

        thumb_size = QSpinBox()
        thumb_size.setRange(32, 128)
        thumb_size.setValue(64)
        thumb_size.setSuffix(" px")
        perf_form.addRow("Thumbnail Size:", thumb_size)

        perf_group.setLayout(perf_form)
        perf_layout.addWidget(perf_group)

        # Caching
        cache_group = QGroupBox("Caching")
        cache_layout = QVBoxLayout()

        enable_cache = QCheckBox("Enable surface preview caching")
        enable_cache.setChecked(True)
        cache_layout.addWidget(enable_cache)

        cache_hint = QLabel("Caching improves performance but uses more memory")
        cache_hint.setStyleSheet("color: #888; font-style: italic;")
        cache_layout.addWidget(cache_hint)

        cache_group.setLayout(cache_layout)
        perf_layout.addWidget(cache_group)

        perf_layout.addStretch()
        tabs.addTab(perf_tab, "Performance")

        # TAB 5: PREVIEW SETTINGS (LAST TAB)

        preview_tab = QWidget()
        preview_layout = QVBoxLayout(preview_tab)

        # Zoom Settings
        zoom_group = QGroupBox("Zoom Settings")
        zoom_form = QFormLayout()

        zoom_spin = QSpinBox()
        zoom_spin.setRange(10, 500)
        zoom_spin.setValue(int(getattr(self, 'zoom_level', 1.0) * 100))
        zoom_spin.setSuffix("%")
        zoom_form.addRow("Default Zoom:", zoom_spin)

        zoom_group.setLayout(zoom_form)
        preview_layout.addWidget(zoom_group)

        # Background Settings
        bg_group = QGroupBox("Background Settings")
        bg_layout = QVBoxLayout()

        # Background mode
        bg_mode_layout = QFormLayout()
        bg_mode_combo = QComboBox()
        bg_mode_combo.addItems(["Solid Color", "Checkerboard", "Grid"])
        current_bg_mode = getattr(self, 'background_mode', 'solid')
        mode_idx = {"solid": 0, "checkerboard": 1, "checker": 1, "grid": 2}.get(current_bg_mode, 0)
        bg_mode_combo.setCurrentIndex(mode_idx)
        bg_mode_layout.addRow("Background Mode:", bg_mode_combo)
        bg_layout.addLayout(bg_mode_layout)

        bg_layout.addSpacing(10)

        # Checkerboard size
        cb_label = QLabel("Checkerboard Size:")
        bg_layout.addWidget(cb_label)

        cb_layout = QHBoxLayout()
        cb_slider = QSlider(Qt.Orientation.Horizontal)
        cb_slider.setMinimum(4)
        cb_slider.setMaximum(64)
        cb_slider.setValue(getattr(self, '_checkerboard_size', 16))
        cb_slider.setTickPosition(QSlider.TickPosition.TicksBelow)
        cb_slider.setTickInterval(8)
        cb_layout.addWidget(cb_slider)

        cb_spin = QSpinBox()
        cb_spin.setMinimum(4)
        cb_spin.setMaximum(64)
        cb_spin.setValue(getattr(self, '_checkerboard_size', 16))
        cb_spin.setSuffix(" px")
        cb_spin.setFixedWidth(80)
        cb_layout.addWidget(cb_spin)

        bg_layout.addLayout(cb_layout)

        # Connect checkerboard controls
        #cb_slider.valueChanged.connect(cb_spin.setValue)
        #cb_spin.valueChanged.connect(cb_slider.setValue)

        # Hint
        cb_hint = QLabel("Smaller = tighter pattern, larger = bigger squares")
        cb_hint.setStyleSheet("color: #888; font-style: italic; font-size: 10px;")
        bg_layout.addWidget(cb_hint)

        bg_group.setLayout(bg_layout)
        preview_layout.addWidget(bg_group)

        # Overlay Settings
        overlay_group = QGroupBox("Overlay View Settings")
        overlay_layout = QVBoxLayout()

        overlay_label = QLabel("Overlay Opacity (Wireframe over mesh):")
        overlay_layout.addWidget(overlay_label)

        opacity_layout = QHBoxLayout()
        opacity_slider = QSlider(Qt.Orientation.Horizontal)
        opacity_slider.setMinimum(0)
        opacity_slider.setMaximum(100)
        opacity_slider.setValue(getattr(self, '_overlay_opacity', 50))
        opacity_slider.setTickPosition(QSlider.TickPosition.TicksBelow)
        opacity_slider.setTickInterval(10)
        opacity_layout.addWidget(opacity_slider)

        opacity_spin = QSpinBox()
        opacity_spin.setMinimum(0)
        opacity_spin.setMaximum(100)
        opacity_spin.setValue(getattr(self, '_overlay_opacity', 50))
        opacity_spin.setSuffix(" %")
        opacity_spin.setFixedWidth(80)
        opacity_layout.addWidget(opacity_spin)

        overlay_layout.addLayout(opacity_layout)

        # Connect opacity controls
        #opacity_slider.valueChanged.connect(opacity_spin.setValue)
        #opacity_spin.valueChanged.connect(opacity_slider.setValue)

        # Hint
        opacity_hint = QLabel("0")
        opacity_hint.setStyleSheet("color: #888; font-style: italic; font-size: 10px;")
        overlay_layout.addWidget(opacity_hint)

        overlay_group.setLayout(overlay_layout)
        preview_layout.addWidget(overlay_group)

        preview_layout.addStretch()
        tabs.addTab(preview_tab, "Preview")

        # Add tabs to dialog
        layout.addWidget(tabs)

        # BUTTONS

        btn_layout = QHBoxLayout()
        btn_layout.addStretch()

        # Apply button
        apply_btn = QPushButton("Apply Settings")
        apply_btn.setStyleSheet("""
            QPushButton {
                background: #0078d4;
                color: white;
                padding: 10px 24px;
                font-weight: bold;
                border-radius: 4px;
                font-size: 13px;
            }
            QPushButton:hover {
                background: #1984d8;
            }
        """)

    def _pick_background_color(self): #vers 1
        """Open color picker for background"""
        color = QColorDialog.getColor(self.preview_widget.bg_color, self, "Pick Background Color")
        if color.isValid():
            self.preview_widget.set_background_color(color)

# - ICON STUBS

# - UI ACTIONS (NO LOGIC) ---

    def _pan_preview(self, dx, dy): pass
    def _toggle_spheres(self, checked): pass
    def _toggle_boxes(self, checked): pass
    def _toggle_mesh(self, checked): pass


    def _create_preview_widget(self, level_data=None): #vers 5
        """Create preview widget - PreviewWidget for col_workshop"""
        if level_data is None:
            # Return collision preview widget for main preview area
            preview = CollisionPreviewWidget(self)
            img_debugger.debug(f"Created PreviewWidget: {type(preview)}")  # ADD THIS
            return preview

        # Original logic with level_data for mipmap/level cards (if needed)
        level_num = level_data.get('level', 0)
        width = level_data.get('width', 0)
        height = level_data.get('height', 0)
        rgba_data = level_data.get('rgba_data')
        preview_size = max(45, 120 - (level_num * 15))

        preview = QLabel()
        preview.setFixedSize(preview_size, preview_size)
        preview.setStyleSheet("""
            QLabel {
                background: #0a0a0a;
                border: 2px solid #3a3a3a;
                border-radius: 3px;
            }
        """)
        preview.setAlignment(Qt.AlignmentFlag.AlignCenter)

        if rgba_data and width > 0:
            try:
                image = QImage(rgba_data, width, height, width * 4, QImage.Format.Format_RGBA8888)
                if not image.isNull():
                    pixmap = QPixmap.fromImage(image)
                    scaled_pixmap = pixmap.scaled(
                        preview_size - 10, preview_size - 10,
                        Qt.AspectRatioMode.KeepAspectRatio,
                        Qt.TransformationMode.SmoothTransformation
                    )
                    preview.setPixmap(scaled_pixmap)
            except:
                preview.setText("No Data")
        else:
            preview.setText("No Data")

        return preview


    def _create_info_section(self, level_data): #vers 1
        """Create info section with stats grid"""
        info_widget = QWidget()
        layout = QVBoxLayout(info_widget)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(10)

        # Header with level number and dimensions
        header_layout = QHBoxLayout()

        level_num = level_data.get('level', 0)
        level_badge = QLabel(f"Level {level_num}")
        level_badge.setStyleSheet("""
            QLabel {
                background: #0d47a1;
                color: white;
                padding: 4px 12px;
                border-radius: 3px;
                font-weight: bold;
                font-size: 13px;
            }
        """)
        header_layout.addWidget(level_badge)

        width = level_data.get('width', 0)
        height = level_data.get('height', 0)
        dim_label = QLabel(f"{width} x {height}")
        dim_label.setStyleSheet("font-size: 16px; font-weight: bold; color: #4a9eff;")
        header_layout.addWidget(dim_label)

        # Main indicator
        if level_num == 0:
            main_badge = QLabel("Main Surface")
            main_badge.setStyleSheet("color: #4caf50; font-size: 12px;")
            header_layout.addWidget(main_badge)

        header_layout.addStretch()
        layout.addLayout(header_layout)

        # Stats grid
        stats_grid = self._create_stats_grid(level_data)
        layout.addWidget(stats_grid)

        return info_widget


    def _create_stats_grid(self, level_data): #vers 1
        """Create stats grid"""
        grid_widget = QWidget()
        grid_layout = QHBoxLayout(grid_widget)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        grid_layout.setSpacing(8)

        fmt = level_data.get('format', self.collision_data.get('format', 'Unknown'))
        size = level_data.get('compressed_size', 0)
        size_kb = size / 1024

        # Format stat
        format_stat = self._create_stat_box("Format:", fmt)
        grid_layout.addWidget(format_stat)

        # Size stat
        size_stat = self._create_stat_box("Size:", f"{size_kb:.1f} KB")
        grid_layout.addWidget(size_stat)
        grid_layout.addWidget(comp_stat)

        # Status stat
        is_modified = level_data.get('level', 0) in self.modified_levels
        status_text = "⚠ Modified" if is_modified else "✓ Valid"
        status_color = "#ff9800" if is_modified else "#4caf50"
        status_stat = self._create_stat_box("Status:", status_text, status_color)
        grid_layout.addWidget(status_stat)

        return grid_widget


    def _create_stat_box(self, label, value, value_color="#e0e0e0"): #vers 1
        """Create individual stat box"""
        stat = QFrame()
        stat.setStyleSheet("""
            QFrame {
                background: #252525;
                border-radius: 3px;
                padding: 6px 10px;
            }
        """)

        layout = QHBoxLayout(stat)
        layout.setContentsMargins(8, 4, 8, 4)

        label_widget = QLabel(label)
        label_widget.setStyleSheet("color: #888; font-size: 12px;")
        layout.addWidget(label_widget)

        value_widget = QLabel(value)
        value_widget.setStyleSheet(f"color: {value_color}; font-weight: bold; font-size: 12px;")
        layout.addWidget(value_widget)

        return stat


    def _create_action_section(self, level_data): #vers 1
        """Create action buttons section"""
        action_widget = QWidget()
        layout = QVBoxLayout(action_widget)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(5)

        level_num = level_data.get('level', 0)

        # Export button
        export_btn = QPushButton("Export")
        export_btn.setStyleSheet("""
            QPushButton {
                background: #2e5d2e;
                border: 1px solid #3d7d3d;
                color: white;
                padding: 6px 12px;
                border-radius: 3px;
                font-size: 11px;
            }
            QPushButton:hover {
                background: #3d7d3d;
            }
        """)
        export_btn.clicked.connect(lambda: self._export_level(level_num))
        layout.addWidget(export_btn)

        # Import button
        import_btn = QPushButton("Import")
        import_btn.setStyleSheet("""
            QPushButton {
                background: #5d3d2e;
                border: 1px solid #7d4d3d;
                color: white;
                padding: 6px 12px;
                border-radius: 3px;
                font-size: 11px;
            }
            QPushButton:hover {
                background: #7d4d3d;
            }
        """)
        import_btn.clicked.connect(lambda: self._import_level(level_num))
        layout.addWidget(import_btn)

        # Delete button (not for level 0) or Edit button (for level 0)
        if level_num == 0:
            edit_btn = QPushButton("Edit")
            edit_btn.setStyleSheet("""
                QPushButton {
                    background: #3a3a3a;
                    border: 1px solid #4a4a4a;
                    color: white;
                    padding: 6px 12px;
                    border-radius: 3px;
                    font-size: 11px;
                }
                QPushButton:hover {
                    background: #4a4a4a;
                }
            """)
            edit_btn.clicked.connect(self._edit_main_surface)
            layout.addWidget(edit_btn)
        else:
            delete_btn = QPushButton("Delete")
            delete_btn.setStyleSheet("""
                QPushButton {
                    background: #5d2e2e;
                    border: 1px solid #7d3d3d;
                    color: white;
                    padding: 6px 12px;
                    border-radius: 3px;
                    font-size: 11px;
                }
                QPushButton:hover {
                    background: #7d3d3d;
                }
            """)
            delete_btn.clicked.connect(lambda: self._delete_level(level_num))
            layout.addWidget(delete_btn)

        return action_widget


# - Docking functions

    def _update_dock_button_visibility(self): #vers 2
        """Show/hide dock and tearoff buttons based on docked state"""
        if hasattr(self, 'dock_btn'):
            # Hide D button when docked, show when standalone
            self.dock_btn.setVisible(not self.is_docked)

        if hasattr(self, 'tearoff_btn'):
            # T button only visible when docked and not in standalone mode
            self.tearoff_btn.setVisible(self.is_docked and not self.standalone_mode)


    def toggle_dock_mode(self): #vers 2
        """Toggle between docked and standalone mode"""
        if self.is_docked:
            self._undock_from_main()
        else:
            self._dock_to_main()

        self._update_dock_button_visibility()


    def _toggle_tearoff(self): #vers 2
        """Toggle tear-off state (merge back to IMG Factory) - IMPROVED"""
        try:
            if self.is_docked:
                # Undock from main window
                self._undock_from_main()
                if hasattr(self.main_window, 'log_message'):
                    self.main_window.log_message(f"{App_name} torn off from main window")
            else:
                # Dock back to main window
                self._dock_to_main()
                if hasattr(self.main_window, 'log_message'):
                    self.main_window.log_message(f"{App_name} docked back to main window")

        except Exception as e:
            img_debugger.error(f"Error toggling tear-off: {str(e)}")
            from PyQt6.QtWidgets import QMessageBox
            QMessageBox.warning(self, "Tear-off Error", f"Could not toggle tear-off state:\n{str(e)}")


    def _dock_to_main(self): #vers 9
        """Dock handled by overlay system in imgfactory - IMPROVED"""
        try:
            if hasattr(self, 'is_overlay') and self.is_overlay:
                self.show()
                self.raise_()
                return

            # For proper docking, we need to be called from imgfactory
            # This method should be handled by imgfactory's overlay system
            if self.main_window and hasattr(self.main_window, App_name + '_docked'):
                # If available, use the main window's docking system
                self.main_window.open_col_workshop_docked()
            else:
                # Fallback: just show the window
                self.show()
                self.raise_()

            # Update dock state
            self.is_docked = True
            self._update_dock_button_visibility()

            if hasattr(self.main_window, 'log_message'):
                self.main_window.log_message(f"{App_name} docked to main window")


        except Exception as e:
            img_debugger.error(f"Error docking: {str(e)}")
            self.show()


    def _undock_from_main(self): #vers 4
        """Undock from overlay mode to standalone window - IMPROVED"""
        try:
            if hasattr(self, 'is_overlay') and self.is_overlay:
                # Switch from overlay to normal window
                self.setWindowFlags(Qt.WindowType.Window)
                self.is_overlay = False
                self.overlay_table = None

            # Set proper window flags for standalone mode
            self.setWindowFlags(Qt.WindowType.Window)

            # Ensure proper size when undocking
            if hasattr(self, 'original_size'):
                self.resize(self.original_size)
            else:
                self.resize(1000, 700)  # Reasonable default size

            self.is_docked = False
            self._update_dock_button_visibility()

            self.show()
            self.raise_()

            if hasattr(self.main_window, 'log_message'):
                self.main_window.log_message(f"{App_name} undocked to standalone")

        except Exception as e:
            img_debugger.error(f"Error undocking: {str(e)}")
            # Fallback
            self.setWindowFlags(Qt.WindowType.Window)
            self.show()


    def update_view_options(viewer: 'COL3DViewport', **options): #vers 1
        """Update 3D viewer options"""
        try:
            viewer.set_view_options(**options)
            img_debugger.debug(f"View options updated: {options}")

            def _ensure_standalone_functionality(self): #vers 1
                """Ensure popped-out windows work independently of img factory"""
                try:
                    # When popped out, ensure all necessary functionality is available
                    if not self.is_docked or getattr(self, 'is_overlay', False) == False:
                        # Enable all UI elements that might be disabled when docked
                        if hasattr(self, 'toolbar') and self.toolbar:
                            self.toolbar.setEnabled(True)

                        # Ensure all buttons and controls work independently
                        if hasattr(self, 'main_window') and self.main_window is None:
                            # This is truly standalone, enable all features
                            if hasattr(self, 'dock_btn'):
                                self.dock_btn.setText("X")  # Change to close button when standalone
                                self.dock_btn.setToolTip("Close window")

                        # Set proper window flags for standalone operation
                        if not getattr(self, 'is_overlay', False):
                            self.setWindowFlags(Qt.WindowType.Window)

                except Exception as e:
                    img_debugger.error(f"Error ensuring standalone functionality: {str(e)}")

        except Exception as e:
            img_debugger.error(f"Error updating view options: {str(e)}")


    def _apply_button_mode(self, dialog): #vers 1
        """Apply button display mode"""
        mode_index = self.button_mode_combo.currentIndex()
        mode_map = {0: 'both', 1: 'icons', 2: 'text'}

        new_mode = mode_map[mode_index]

        if new_mode != self.button_display_mode:
            self.button_display_mode = new_mode
            self._update_all_buttons()

            if self.main_window and hasattr(self.main_window, 'log_message'):
                mode_names = {0: 'Icons + Text', 1: 'Icons Only', 2: 'Text Only'}
                self.main_window.log_message(f"Button style: {mode_names[mode_index]}")

        dialog.close()


    def _apply_fonts_to_widgets(self): #vers 1
        """Apply fonts from AppSettings to all widgets"""
        if not hasattr(self, 'default_font'):
            return

        print("\n=== Applying Fonts ===")
        print(f"Default font: {self.default_font.family()} {self.default_font.pointSize()}pt")
        print(f"Title font: {self.title_font.family()} {self.title_font.pointSize()}pt")
        print(f"Panel font: {self.panel_font.family()} {self.panel_font.pointSize()}pt")
        print(f"Button font: {self.button_font.family()} {self.button_font.pointSize()}pt")

        # Apply default font to main window
        self.setFont(self.default_font)

        # Apply title font to titlebar
        if hasattr(self, 'title_label'):
            self.title_label.setFont(self.title_font)

        # Apply panel font to lists
        if hasattr(self, 'platform_list'):
            self.platform_list.setFont(self.panel_font)
        if hasattr(self, 'game_list'):
            self.game_list.setFont(self.panel_font)

        # Apply button font to all buttons
        for btn in self.findChildren(QPushButton):
            btn.setFont(self.button_font)

        print("Fonts applied to widgets")
        print("======================\n")


    def _update_toolbar_for_docking_state(self): #vers 1
        """Update toolbar visibility based on docking state"""
        # Hide/show drag button based on docking state
        if hasattr(self, 'drag_btn'):
            self.drag_btn.setVisible(not self.is_docked)


    def _show_about_dialog(self): #vers 1
        """Show about/info dialog for ResBio-Evil-Workshop"""
        from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QPushButton, QTabWidget, QWidget, QGroupBox, QFormLayout, QSpinBox, QComboBox, QSlider, QLabel, QCheckBox, QFontComboBox, QTextBrowser)
        from PyQt6.QtCore import Qt
        from PyQt6.QtGui import QFont

        dialog = QDialog(self)
        dialog.setWindowTitle("About ResBio-Evil-Workshop")
        dialog.setMinimumSize(700, 600)

        layout = QVBoxLayout()

        # Title
        title = QLabel("ResBio-Evil-Workshop 1.0")
        title_font = QFont(self.title_font)
        title_font.setPointSize(16)
        title_font.setBold(True)
        title.setFont(title_font)
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(title)

        # Author info
        author = QLabel("Created by X-Seti")
        author.setAlignment(Qt.AlignmentFlag.AlignCenter)
        author_font = QFont(self.panel_font)
        author_font.setPointSize(12)
        author.setFont(author_font)
        layout.addWidget(author)

        # Year
        year = QLabel("© 2025")
        year.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(year)

        layout.addSpacing(20)

        # Info browser
        info_browser = QTextBrowser()
        info_browser.setOpenExternalLinks(True)

        info_html = """
        <h3>About This Tool</h3>
        <p>ResBio-Evil-Workshop is a comprehensive Resident Evil file format editor and room viewer
        for PS1/PC versions of RE1, RE2, and RE3. It provides tools for analyzing and editing
        game assets including rooms, models, textures, and collision data.</p>

        <h3>Key Features</h3>
        <ul>
            <li><b>File Format Support</b>
                <ul>
                    <li>RDT (Room Description Table) - Room geometry and data</li>
                    <li>EMD (3D Models) - Character and object models</li>
                    <li>MD1 (3D Models) - RE2/RE3 model format</li>
                    <li>TIM (Textures) - PS1 texture format</li>
                    <li>SCA (Collision) - Collision boundaries</li>
                    <li>SCD (Scripts) - Room scripts and logic</li>
                </ul>
            </li>
            <li><b>Multi-Version Support</b> - RE1, RE2, and RE3 (PS1 and PC versions)</li>
            <li><b>Research Database</b>
                <ul>
                    <li>Store and organize file format findings</li>
                    <li>Tag-based categorization</li>
                    <li>Full-text search across research entries</li>
                    <li>Export research to markdown</li>
                </ul>
            </li>
            <li><b>Multi-View Display Panel</b>
                <ul>
                    <li>Text viewer for documentation and research</li>
                    <li>3D Model viewer (placeholder for implementation)</li>
                    <li>Texture viewer (placeholder for implementation)</li>
                    <li>Collision visualizer (placeholder for implementation)</li>
                    <li>Info panel for properties</li>
                </ul>
            </li>
            <li><b>Theme System</b>
                <ul>
                    <li>Light/dark theme detection and adaptation</li>
                    <li>Theme-friendly styling throughout</li>
                    <li>20+ bundled themes</li>
                    <li>Custom theme support</li>
                </ul>
            </li>
            <li><b>Customizable Interface</b>
                <ul>
                    <li>Toolbar with quick access buttons</li>
                    <li>Multi-panel layout (left, middle, right)</li>
                    <li>SVG-based icons</li>
                    <li>Resizable panels</li>
                </ul>
            </li>
        </ul>

        <h3>Technical Details</h3>
        <ul>
            <li><b>Framework:</b> PyQt6</li>
            <li><b>Architecture:</b> Modular design with separated concerns</li>
            <li><b>Graphics:</b> SVG-based scalable icons</li>
            <li><b>Theme Engine:</b> App-System-Settings integration</li>
            <li><b>Platform:</b> Cross-platform (Linux, Windows, macOS)</li>
            <li><b>Reference Implementation:</b> reevengi-tools (GitHub)</li>
        </ul>

        <h3>Project Structure</h3>
        <ul>
            <li><b>core/</b> - Core database and file parsing</li>
            <li><b>components/</b> - GUI components and editors</li>
            <li><b>methods/</b> - Shared utility methods</li>
            <li><b>depends/</b> - Dependencies and helpers</li>
            <li><b>utils/</b> - Settings and theme management</li>
            <li><b>themes/</b> - Theme JSON files</li>
        </ul>

        <h3>Development Status</h3>
        <ul>
            <li><b>Phase 1:</b> File format research and documentation ✓</li>
            <li><b>Phase 2:</b> RDT parser implementation (in progress)</li>
            <li><b>Phase 3:</b> EMD model parser</li>
            <li><b>Phase 4:</b> TIM texture support</li>
            <li><b>Phase 5:</b> 3D visualization and collision display</li>
        </ul>

        <h3>Research & References</h3>
        <ul>
            <li><b>reevengi-tools</b> - Open source RE file format tools
                <ul>
                    <li><a href="https://github.com/pmandin/reevengi-tools">GitHub Repository</a></li>
                    <li>RDT/EMD/TIM format specifications</li>
                </ul>
            </li>
            <li><b>RE Modding Community</b> - Forums and wikis with format documentation</li>
        </ul>

        <h3>GitHub Repository</h3>
        <p><a href="https://github.com/X-Seti/Resbio-Evil-Workshop">
        https://github.com/X-Seti/Resbio-Evil-Workshop</a></p>

        <h3>Code Organization</h3>
        <p>This project follows strict organizational rules:</p>
        <ul>
            <li>File headers with "X-Seti - [Date] 2025" format</li>
            <li>Alphabetical method listings with version tracking</li>
            <li>No "Enhanced/Fixed/Improved" naming patterns</li>
            <li>Organized folder structure by function</li>
            <li>SVG icons only (no emojis)</li>
            <li>No duplicate functions across files</li>
            <li>Shared functions in methods/ folder</li>
        </ul>

        <br>
        <p><i>Built with attention to detail, commitment to quality code, and passion for RE file formats.</i></p>
        """

        info_browser.setHtml(info_html)
        layout.addWidget(info_browser)

        # Close button
        close_btn = QPushButton("Close")
        close_btn.clicked.connect(dialog.accept)
        layout.addWidget(close_btn)

        dialog.setLayout(layout)

        dialog.exec()

# - GUI button update

    def _show_workshop_settings(self): #vers 1 < moved from TXD workshop
        """Show complete workshop settings dialog"""
        from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QPushButton, QTabWidget, QWidget, QGroupBox, QFormLayout, QSpinBox, QComboBox, QSlider, QLabel, QCheckBox, QFontComboBox)
        from PyQt6.QtCore import Qt
        from PyQt6.QtGui import QFont

        dialog = QDialog(self)
        dialog.setWindowTitle(App_name + " Settings")
        dialog.setMinimumWidth(650)
        dialog.setMinimumHeight(550)

        layout = QVBoxLayout(dialog)

        # Create tabs
        tabs = QTabWidget()

        # TAB 1: FONTS (FIRST TAB)

        fonts_tab = QWidget()
        fonts_layout = QVBoxLayout(fonts_tab)

        # Default Font
        default_font_group = QGroupBox("Default Font")
        default_font_layout = QHBoxLayout()

        default_font_combo = QFontComboBox()
        default_font_combo.setCurrentFont(self.font())
        default_font_layout.addWidget(default_font_combo)

        default_font_size = QSpinBox()
        default_font_size.setRange(8, 24)
        default_font_size.setValue(self.font().pointSize())
        default_font_size.setSuffix(" pt")
        default_font_size.setFixedWidth(80)
        default_font_layout.addWidget(default_font_size)

        default_font_group.setLayout(default_font_layout)
        fonts_layout.addWidget(default_font_group)

        # Title Font
        title_font_group = QGroupBox("Title Font")
        title_font_layout = QHBoxLayout()

        title_font_combo = QFontComboBox()
        if hasattr(self, 'title_font'):
            title_font_combo.setCurrentFont(self.title_font)
        else:
            title_font_combo.setCurrentFont(QFont("Arial", 14))
        title_font_layout.addWidget(title_font_combo)

        title_font_size = QSpinBox()
        title_font_size.setRange(10, 32)
        title_font_size.setValue(getattr(self, 'title_font', QFont("Arial", 14)).pointSize())
        title_font_size.setSuffix(" pt")
        title_font_size.setFixedWidth(80)
        title_font_layout.addWidget(title_font_size)

        title_font_group.setLayout(title_font_layout)
        fonts_layout.addWidget(title_font_group)

        # Panel Font
        panel_font_group = QGroupBox("Panel Headers Font")
        panel_font_layout = QHBoxLayout()

        panel_font_combo = QFontComboBox()
        if hasattr(self, 'panel_font'):
            panel_font_combo.setCurrentFont(self.panel_font)
        else:
            panel_font_combo.setCurrentFont(QFont("Arial", 10))
        panel_font_layout.addWidget(panel_font_combo)

        panel_font_size = QSpinBox()
        panel_font_size.setRange(8, 18)
        panel_font_size.setValue(getattr(self, 'panel_font', QFont("Arial", 10)).pointSize())
        panel_font_size.setSuffix(" pt")
        panel_font_size.setFixedWidth(80)
        panel_font_layout.addWidget(panel_font_size)

        panel_font_group.setLayout(panel_font_layout)
        fonts_layout.addWidget(panel_font_group)

        # Button Font
        button_font_group = QGroupBox("Button Font")
        button_font_layout = QHBoxLayout()

        button_font_combo = QFontComboBox()
        if hasattr(self, 'button_font'):
            button_font_combo.setCurrentFont(self.button_font)
        else:
            button_font_combo.setCurrentFont(QFont("Arial", 10))
        button_font_layout.addWidget(button_font_combo)

        button_font_size = QSpinBox()
        button_font_size.setRange(8, 16)
        button_font_size.setValue(getattr(self, 'button_font', QFont("Arial", 10)).pointSize())
        button_font_size.setSuffix(" pt")
        button_font_size.setFixedWidth(80)
        button_font_layout.addWidget(button_font_size)

        button_font_group.setLayout(button_font_layout)
        fonts_layout.addWidget(button_font_group)

        # Info Bar Font
        infobar_font_group = QGroupBox("Info Bar Font")
        infobar_font_layout = QHBoxLayout()

        infobar_font_combo = QFontComboBox()
        if hasattr(self, 'infobar_font'):
            infobar_font_combo.setCurrentFont(self.infobar_font)
        else:
            infobar_font_combo.setCurrentFont(QFont("Courier New", 9))
        infobar_font_layout.addWidget(infobar_font_combo)

        infobar_font_size = QSpinBox()
        infobar_font_size.setRange(7, 14)
        infobar_font_size.setValue(getattr(self, 'infobar_font', QFont("Courier New", 9)).pointSize())
        infobar_font_size.setSuffix(" pt")
        infobar_font_size.setFixedWidth(80)
        infobar_font_layout.addWidget(infobar_font_size)

        infobar_font_group.setLayout(infobar_font_layout)
        fonts_layout.addWidget(infobar_font_group)

        fonts_layout.addStretch()
        tabs.addTab(fonts_tab, "Fonts")

        # TAB 2: DISPLAY SETTINGS

        display_tab = QWidget()
        display_layout = QVBoxLayout(display_tab)

        # Button display mode
        button_group = QGroupBox("Button Display Mode")
        button_layout = QVBoxLayout()

        button_mode_combo = QComboBox()
        button_mode_combo.addItems(["Icons + Text", "Icons Only", "Text Only"])
        current_mode = getattr(self, 'button_display_mode', 'both')
        mode_map = {'both': 0, 'icons': 1, 'text': 2}
        button_mode_combo.setCurrentIndex(mode_map.get(current_mode, 0))
        button_layout.addWidget(button_mode_combo)

        button_hint = QLabel("Changes how toolbar buttons are displayed")
        button_hint.setStyleSheet("color: #888; font-style: italic;")
        button_layout.addWidget(button_hint)

        button_group.setLayout(button_layout)
        display_layout.addWidget(button_group)

        # Table display
        table_group = QGroupBox("Texture List Display")
        table_layout = QVBoxLayout()

        show_thumbnails = QCheckBox("Show texture thumbnails")
        show_thumbnails.setChecked(True)
        table_layout.addWidget(show_thumbnails)

        show_warnings = QCheckBox("Show warning icons for suspicious textures")
        show_warnings.setChecked(True)
        show_warnings.setToolTip("Shows icon if normal and alpha appear identical")
        table_layout.addWidget(show_warnings)

        table_group.setLayout(table_layout)
        display_layout.addWidget(table_group)

        display_layout.addStretch()
        tabs.addTab(display_tab, "Display")



        # TAB 3: placeholder
        # TAB 4: PERFORMANCE

        perf_tab = QWidget()
        perf_layout = QVBoxLayout(perf_tab)

        perf_group = QGroupBox("Performance Settings")
        perf_form = QFormLayout()

        preview_quality = QComboBox()
        preview_quality.addItems(["Low (Fast)", "Medium", "High (Slow)"])
        preview_quality.setCurrentIndex(1)
        perf_form.addRow("Preview Quality:", preview_quality)

        thumb_size = QSpinBox()
        thumb_size.setRange(32, 128)
        thumb_size.setValue(64)
        thumb_size.setSuffix(" px")
        perf_form.addRow("Thumbnail Size:", thumb_size)

        perf_group.setLayout(perf_form)
        perf_layout.addWidget(perf_group)

        # Caching
        cache_group = QGroupBox("Caching")
        cache_layout = QVBoxLayout()

        enable_cache = QCheckBox("Enable texture preview caching")
        enable_cache.setChecked(True)
        cache_layout.addWidget(enable_cache)

        cache_hint = QLabel("Caching improves performance but uses more memory")
        cache_hint.setStyleSheet("color: #888; font-style: italic;")
        cache_layout.addWidget(cache_hint)

        cache_group.setLayout(cache_layout)
        perf_layout.addWidget(cache_group)

        perf_layout.addStretch()
        tabs.addTab(perf_tab, "Performance")

        # TAB 5: PREVIEW SETTINGS (LAST TAB)

        preview_tab = QWidget()
        preview_layout = QVBoxLayout(preview_tab)

        # Zoom Settings
        zoom_group = QGroupBox("Zoom Settings")
        zoom_form = QFormLayout()

        zoom_spin = QSpinBox()
        zoom_spin.setRange(10, 500)
        zoom_spin.setValue(int(getattr(self, 'zoom_level', 1.0) * 100))
        zoom_spin.setSuffix("%")
        zoom_form.addRow("Default Zoom:", zoom_spin)

        zoom_group.setLayout(zoom_form)
        preview_layout.addWidget(zoom_group)

        # Background Settings
        bg_group = QGroupBox("Background Settings")
        bg_layout = QVBoxLayout()

        # Background mode
        bg_mode_layout = QFormLayout()
        bg_mode_combo = QComboBox()
        bg_mode_combo.addItems(["Solid Color", "Checkerboard", "Grid"])
        current_bg_mode = getattr(self, 'background_mode', 'solid')
        mode_idx = {"solid": 0, "checkerboard": 1, "checker": 1, "grid": 2}.get(current_bg_mode, 0)

        bg_mode_combo.setCurrentIndex(mode_idx)
        bg_mode_layout.addRow("Background Mode:", bg_mode_combo)
        bg_layout.addLayout(bg_mode_layout)

        bg_layout.addSpacing(10)

        # Checkerboard size
        cb_label = QLabel("Checkerboard Size:")
        bg_layout.addWidget(cb_label)

        cb_layout = QHBoxLayout()
        cb_slider = QSlider(Qt.Orientation.Horizontal)
        cb_slider.setMinimum(4)
        cb_slider.setMaximum(64)
        cb_slider.setValue(getattr(self, '_checkerboard_size', 16))
        cb_slider.setTickPosition(QSlider.TickPosition.TicksBelow)
        cb_slider.setTickInterval(8)
        cb_layout.addWidget(cb_slider)

        cb_spin = QSpinBox()
        cb_spin.setMinimum(4)
        cb_spin.setMaximum(64)
        cb_spin.setValue(getattr(self, '_checkerboard_size', 16))
        cb_spin.setSuffix(" px")
        cb_spin.setFixedWidth(80)
        cb_layout.addWidget(cb_spin)

        bg_layout.addLayout(cb_layout)

        # Connect checkerboard controls
        #cb_slider.valueChanged.connect(cb_spin.setValue)
        #cb_spin.valueChanged.connect(cb_slider.setValue)

        # Hint
        cb_hint = QLabel("Smaller = tighter pattern, larger = bigger squares")
        cb_hint.setStyleSheet("color: #888; font-style: italic; font-size: 10px;")
        bg_layout.addWidget(cb_hint)

        bg_group.setLayout(bg_layout)
        preview_layout.addWidget(bg_group)

        # Overlay Settings
        overlay_group = QGroupBox("Overlay View Settings")
        overlay_layout = QVBoxLayout()

        overlay_label = QLabel("Overlay Opacity (Normal over Alpha):")
        overlay_layout.addWidget(overlay_label)

        opacity_layout = QHBoxLayout()
        opacity_slider = QSlider(Qt.Orientation.Horizontal)
        opacity_slider.setMinimum(0)
        opacity_slider.setMaximum(100)
        opacity_slider.setValue(getattr(self, '_overlay_opacity', 50))
        opacity_slider.setTickPosition(QSlider.TickPosition.TicksBelow)
        opacity_slider.setTickInterval(10)
        opacity_layout.addWidget(opacity_slider)

        opacity_spin = QSpinBox()
        opacity_spin.setMinimum(0)
        opacity_spin.setMaximum(100)
        opacity_spin.setValue(getattr(self, '_overlay_opacity', 50))
        opacity_spin.setSuffix(" %")
        opacity_spin.setFixedWidth(80)
        opacity_layout.addWidget(opacity_spin)

        overlay_layout.addLayout(opacity_layout)

        # Connect opacity controls
        #opacity_slider.valueChanged.connect(opacity_spin.setValue)
        #opacity_spin.valueChanged.connect(opacity_slider.setValue)

        # Hint
        opacity_hint = QLabel("0")
        opacity_hint.setStyleSheet("color: #888; font-style: italic; font-size: 10px;")
        overlay_layout.addWidget(opacity_hint)

        overlay_group.setLayout(overlay_layout)
        preview_layout.addWidget(overlay_group)

        preview_layout.addStretch()
        tabs.addTab(preview_tab, "Preview")

        # Add tabs to dialog
        layout.addWidget(tabs)

        # BUTTONS

        btn_layout = QHBoxLayout()
        btn_layout.addStretch()

        # Apply button
        apply_btn = QPushButton("Apply Settings")
        apply_btn.setStyleSheet("""
            QPushButton {
                background: #0078d4;
                color: white;
                padding: 10px 24px;
                font-weight: bold;
                border-radius: 4px;
                font-size: 13px;
            }
            QPushButton:hover {
                background: #1984d8;
            }
        """)


    def _update_all_buttons(self): #vers 4
        # Update all buttons to match display mode
        buttons_to_update = [
            # Toolbar buttons
            ('open_btn', 'Open'),
            ('save_btn', 'Save'),
        ]


    def _get_icon_color(self): #vers 1
        """Get icon color from current theme"""
        if APPSETTINGS_AVAILABLE and self.app_settings:
            colors = self.app_settings.get_theme_colors()
            return colors.get('text_primary', '#ffffff')
        return '#ffffff'





    def _show_workshop_settings(self): #vers 1 < moved from TXD workshop
        """Show complete workshop settings dialog"""
        from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QPushButton, QTabWidget, QWidget, QGroupBox, QFormLayout, QSpinBox, QComboBox, QSlider, QLabel, QCheckBox, QFontComboBox)
        from PyQt6.QtCore import Qt
        from PyQt6.QtGui import QFont

        dialog = QDialog(self)
        dialog.setWindowTitle(App_name + " Settings")
        dialog.setMinimumWidth(650)
        dialog.setMinimumHeight(550)

        layout = QVBoxLayout(dialog)

        # Create tabs
        tabs = QTabWidget()

        # TAB 1: FONTS (FIRST TAB)

        fonts_tab = QWidget()
        fonts_layout = QVBoxLayout(fonts_tab)

        # Default Font
        default_font_group = QGroupBox("Default Font")
        default_font_layout = QHBoxLayout()

        default_font_combo = QFontComboBox()
        default_font_combo.setCurrentFont(self.font())
        default_font_layout.addWidget(default_font_combo)

        default_font_size = QSpinBox()
        default_font_size.setRange(8, 24)
        default_font_size.setValue(self.font().pointSize())
        default_font_size.setSuffix(" pt")
        default_font_size.setFixedWidth(80)
        default_font_layout.addWidget(default_font_size)

        default_font_group.setLayout(default_font_layout)
        fonts_layout.addWidget(default_font_group)

        # Title Font
        title_font_group = QGroupBox("Title Font")
        title_font_layout = QHBoxLayout()

        title_font_combo = QFontComboBox()
        if hasattr(self, 'title_font'):
            title_font_combo.setCurrentFont(self.title_font)
        else:
            title_font_combo.setCurrentFont(QFont("Arial", 14))
        title_font_layout.addWidget(title_font_combo)

        title_font_size = QSpinBox()
        title_font_size.setRange(10, 32)
        title_font_size.setValue(getattr(self, 'title_font', QFont("Arial", 14)).pointSize())
        title_font_size.setSuffix(" pt")
        title_font_size.setFixedWidth(80)
        title_font_layout.addWidget(title_font_size)

        title_font_group.setLayout(title_font_layout)
        fonts_layout.addWidget(title_font_group)

        # Panel Font
        panel_font_group = QGroupBox("Panel Headers Font")
        panel_font_layout = QHBoxLayout()

        panel_font_combo = QFontComboBox()
        if hasattr(self, 'panel_font'):
            panel_font_combo.setCurrentFont(self.panel_font)
        else:
            panel_font_combo.setCurrentFont(QFont("Arial", 10))
        panel_font_layout.addWidget(panel_font_combo)

        panel_font_size = QSpinBox()
        panel_font_size.setRange(8, 18)
        panel_font_size.setValue(getattr(self, 'panel_font', QFont("Arial", 10)).pointSize())
        panel_font_size.setSuffix(" pt")
        panel_font_size.setFixedWidth(80)
        panel_font_layout.addWidget(panel_font_size)

        panel_font_group.setLayout(panel_font_layout)
        fonts_layout.addWidget(panel_font_group)

        # Button Font
        button_font_group = QGroupBox("Button Font")
        button_font_layout = QHBoxLayout()

        button_font_combo = QFontComboBox()
        if hasattr(self, 'button_font'):
            button_font_combo.setCurrentFont(self.button_font)
        else:
            button_font_combo.setCurrentFont(QFont("Arial", 10))
        button_font_layout.addWidget(button_font_combo)

        button_font_size = QSpinBox()
        button_font_size.setRange(8, 16)
        button_font_size.setValue(getattr(self, 'button_font', QFont("Arial", 10)).pointSize())
        button_font_size.setSuffix(" pt")
        button_font_size.setFixedWidth(80)
        button_font_layout.addWidget(button_font_size)

        button_font_group.setLayout(button_font_layout)
        fonts_layout.addWidget(button_font_group)

        # Info Bar Font
        infobar_font_group = QGroupBox("Info Bar Font")
        infobar_font_layout = QHBoxLayout()

        infobar_font_combo = QFontComboBox()
        if hasattr(self, 'infobar_font'):
            infobar_font_combo.setCurrentFont(self.infobar_font)
        else:
            infobar_font_combo.setCurrentFont(QFont("Courier New", 9))
        infobar_font_layout.addWidget(infobar_font_combo)

        infobar_font_size = QSpinBox()
        infobar_font_size.setRange(7, 14)
        infobar_font_size.setValue(getattr(self, 'infobar_font', QFont("Courier New", 9)).pointSize())
        infobar_font_size.setSuffix(" pt")
        infobar_font_size.setFixedWidth(80)
        infobar_font_layout.addWidget(infobar_font_size)

        infobar_font_group.setLayout(infobar_font_layout)
        fonts_layout.addWidget(infobar_font_group)

        fonts_layout.addStretch()
        tabs.addTab(fonts_tab, "Fonts")

        # TAB 2: DISPLAY SETTINGS

        display_tab = QWidget()
        display_layout = QVBoxLayout(display_tab)

        # Button display mode
        button_group = QGroupBox("Button Display Mode")
        button_layout = QVBoxLayout()

        button_mode_combo = QComboBox()
        button_mode_combo.addItems(["Icons + Text", "Icons Only", "Text Only"])
        current_mode = getattr(self, 'button_display_mode', 'both')
        mode_map = {'both': 0, 'icons': 1, 'text': 2}
        button_mode_combo.setCurrentIndex(mode_map.get(current_mode, 0))
        button_layout.addWidget(button_mode_combo)

        button_hint = QLabel("Changes how toolbar buttons are displayed")
        button_hint.setStyleSheet("color: #888; font-style: italic;")
        button_layout.addWidget(button_hint)

        button_group.setLayout(button_layout)
        display_layout.addWidget(button_group)

        # Table display
        table_group = QGroupBox("Texture List Display")
        table_layout = QVBoxLayout()

        show_thumbnails = QCheckBox("Show texture thumbnails")
        show_thumbnails.setChecked(True)
        table_layout.addWidget(show_thumbnails)

        show_warnings = QCheckBox("Show warning icons for suspicious textures")
        show_warnings.setChecked(True)
        show_warnings.setToolTip("Shows icon if normal and alpha appear identical")
        table_layout.addWidget(show_warnings)

        table_group.setLayout(table_layout)
        display_layout.addWidget(table_group)

        display_layout.addStretch()
        tabs.addTab(display_tab, "Display")


        # TAB 3: placeholder
        # TAB 4: PERFORMANCE

        perf_tab = QWidget()
        perf_layout = QVBoxLayout(perf_tab)

        perf_group = QGroupBox("Performance Settings")
        perf_form = QFormLayout()

        preview_quality = QComboBox()
        preview_quality.addItems(["Low (Fast)", "Medium", "High (Slow)"])
        preview_quality.setCurrentIndex(1)
        perf_form.addRow("Preview Quality:", preview_quality)

        thumb_size = QSpinBox()
        thumb_size.setRange(32, 128)
        thumb_size.setValue(64)
        thumb_size.setSuffix(" px")
        perf_form.addRow("Thumbnail Size:", thumb_size)

        perf_group.setLayout(perf_form)
        perf_layout.addWidget(perf_group)

        # Caching
        cache_group = QGroupBox("Caching")
        cache_layout = QVBoxLayout()

        enable_cache = QCheckBox("Enable texture preview caching")
        enable_cache.setChecked(True)
        cache_layout.addWidget(enable_cache)

        cache_hint = QLabel("Caching improves performance but uses more memory")
        cache_hint.setStyleSheet("color: #888; font-style: italic;")
        cache_layout.addWidget(cache_hint)

        cache_group.setLayout(cache_layout)
        perf_layout.addWidget(cache_group)

        perf_layout.addStretch()
        tabs.addTab(perf_tab, "Performance")

        # TAB 5: PREVIEW SETTINGS (LAST TAB)

        preview_tab = QWidget()
        preview_layout = QVBoxLayout(preview_tab)

        # Zoom Settings
        zoom_group = QGroupBox("Zoom Settings")
        zoom_form = QFormLayout()

        zoom_spin = QSpinBox()
        zoom_spin.setRange(10, 500)
        zoom_spin.setValue(int(getattr(self, 'zoom_level', 1.0) * 100))
        zoom_spin.setSuffix("%")
        zoom_form.addRow("Default Zoom:", zoom_spin)

        zoom_group.setLayout(zoom_form)
        preview_layout.addWidget(zoom_group)

        # Background Settings
        bg_group = QGroupBox("Background Settings")
        bg_layout = QVBoxLayout()

        # Background mode
        bg_mode_layout = QFormLayout()
        bg_mode_combo = QComboBox()
        bg_mode_combo.addItems(["Solid Color", "Checkerboard", "Grid"])
        current_bg_mode = getattr(self, 'background_mode', 'solid')
        mode_idx = {"solid": 0, "checkerboard": 1, "checker": 1, "grid": 2}.get(current_bg_mode, 0)

        bg_mode_combo.setCurrentIndex(mode_idx)
        bg_mode_layout.addRow("Background Mode:", bg_mode_combo)
        bg_layout.addLayout(bg_mode_layout)

        bg_layout.addSpacing(10)

        # Checkerboard size
        cb_label = QLabel("Checkerboard Size:")
        bg_layout.addWidget(cb_label)

        cb_layout = QHBoxLayout()
        cb_slider = QSlider(Qt.Orientation.Horizontal)
        cb_slider.setMinimum(4)
        cb_slider.setMaximum(64)
        cb_slider.setValue(getattr(self, '_checkerboard_size', 16))
        cb_slider.setTickPosition(QSlider.TickPosition.TicksBelow)
        cb_slider.setTickInterval(8)
        cb_layout.addWidget(cb_slider)

        cb_spin = QSpinBox()
        cb_spin.setMinimum(4)
        cb_spin.setMaximum(64)
        cb_spin.setValue(getattr(self, '_checkerboard_size', 16))
        cb_spin.setSuffix(" px")
        cb_spin.setFixedWidth(80)
        cb_layout.addWidget(cb_spin)

        bg_layout.addLayout(cb_layout)

        # Connect checkerboard controls
        #cb_slider.valueChanged.connect(cb_spin.setValue)
        #cb_spin.valueChanged.connect(cb_slider.setValue)

        # Hint
        cb_hint = QLabel("Smaller = tighter pattern, larger = bigger squares")
        cb_hint.setStyleSheet("color: #888; font-style: italic; font-size: 10px;")
        bg_layout.addWidget(cb_hint)

        bg_group.setLayout(bg_layout)
        preview_layout.addWidget(bg_group)

        # Overlay Settings
        overlay_group = QGroupBox("Overlay View Settings")
        overlay_layout = QVBoxLayout()

        overlay_label = QLabel("Overlay Opacity (Normal over Alpha):")
        overlay_layout.addWidget(overlay_label)

        opacity_layout = QHBoxLayout()
        opacity_slider = QSlider(Qt.Orientation.Horizontal)
        opacity_slider.setMinimum(0)
        opacity_slider.setMaximum(100)
        opacity_slider.setValue(getattr(self, '_overlay_opacity', 50))
        opacity_slider.setTickPosition(QSlider.TickPosition.TicksBelow)
        opacity_slider.setTickInterval(10)
        opacity_layout.addWidget(opacity_slider)

        opacity_spin = QSpinBox()
        opacity_spin.setMinimum(0)
        opacity_spin.setMaximum(100)
        opacity_spin.setValue(getattr(self, '_overlay_opacity', 50))
        opacity_spin.setSuffix(" %")
        opacity_spin.setFixedWidth(80)
        opacity_layout.addWidget(opacity_spin)

        overlay_layout.addLayout(opacity_layout)

        # Connect opacity controls
        #opacity_slider.valueChanged.connect(opacity_spin.setValue)
        #opacity_spin.valueChanged.connect(opacity_slider.setValue)

        # Hint
        opacity_hint = QLabel("0")
        opacity_hint.setStyleSheet("color: #888; font-style: italic; font-size: 10px;")
        overlay_layout.addWidget(opacity_hint)

        overlay_group.setLayout(overlay_layout)
        preview_layout.addWidget(overlay_group)

        preview_layout.addStretch()
        tabs.addTab(preview_tab, "Preview")

        # Add tabs to dialog
        layout.addWidget(tabs)

        # BUTTONS

        btn_layout = QHBoxLayout()
        btn_layout.addStretch()

        # Apply button
        apply_btn = QPushButton("Apply Settings")
        apply_btn.setStyleSheet("""
            QPushButton {
                background: #0078d4;
                color: white;
                padding: 10px 24px;
                font-weight: bold;
                border-radius: 4px;
                font-size: 13px;
            }
            QPushButton:hover {
                background: #1984d8;
            }
        """)


        def _apply_settings():
            # FONTS
            self.setFont(QFont(default_font_combo.currentFont().family(),
                            default_font_size.value()))
            self.title_font = QFont(title_font_combo.currentFont().family(),
                                title_font_size.value())
            self.panel_font = QFont(panel_font_combo.currentFont().family(),
                                panel_font_size.value())
            self.button_font = QFont(button_font_combo.currentFont().family(),
                                    button_font_size.value())
            self.infobar_font = QFont(infobar_font_combo.currentFont().family(),
                                    infobar_font_size.value())

            # Apply fonts to UI
            self._apply_title_font()
            self._apply_panel_font()
            self._apply_button_font()
            self._apply_infobar_font()

            mode_map = {0: 'both', 1: 'icons', 2: 'text'}
            self.button_display_mode = mode_map[button_mode_combo.currentIndex()]

            # EXPORT
            self.default_export_format = format_combo.currentText()

            # PREVIEW
            self.zoom_level = zoom_spin.value() / 100.0

            bg_modes = ['solid', 'checkerboard', 'grid']
            self.background_mode = bg_modes[bg_mode_combo.currentIndex()]

            self._checkerboard_size = cb_spin.value()
            self._overlay_opacity = opacity_spin.value()

            # Update preview widget
            if hasattr(self, 'preview_widget'):
                if self.background_mode == 'checkerboard':
                    self.preview_widget.set_checkerboard_background()
                    self.preview_widget._checkerboard_size = self._checkerboard_size
                else:
                    self.preview_widget.set_background_color(self.preview_widget.bg_color)

            # Apply button display mode
            if hasattr(self, '_update_all_buttons'):
                self._update_all_buttons()

            # Refresh display

            if self.main_window and hasattr(self.main_window, 'log_message'):
                self.main_window.log_message("Workshop settings updated successfully")

        apply_btn.clicked.connect(_apply_settings)
        btn_layout.addWidget(apply_btn)

        # Close button
        close_btn = QPushButton("Close")
        close_btn.setStyleSheet("padding: 10px 24px; font-size: 13px;")
        close_btn.clicked.connect(dialog.close)
        btn_layout.addWidget(close_btn)

        layout.addLayout(btn_layout)

        # Show dialog
        dialog.exec()


    def _apply_settings_OLD(self, dialog): #vers 5
        """Apply settings from dialog"""
        from PyQt6.QtGui import QFont

        # Store font settings
        self.title_font = QFont(self.title_font_combo.currentFont().family(), self.title_font_size.value())
        self.panel_font = QFont(self.panel_font_combo.currentFont().family(), self.panel_font_size.value())
        self.button_font = QFont(self.button_font_combo.currentFont().family(), self.button_font_size.value())
        self.infobar_font = QFont(self.infobar_font_combo.currentFont().family(), self.infobar_font_size.value())

        # Apply fonts to specific elements
        self._apply_title_font()
        self._apply_panel_font()
        self._apply_button_font()
        self._apply_infobar_font()
        self.default_export_format = format_combo.currentText()

        # Apply button display mode
        mode_map = ["icons", "text", "both"]
        new_mode = mode_map[self.settings_display_combo.currentIndex()]
        if new_mode != self.button_display_mode:
            self.button_display_mode = new_mode
            self._update_all_buttons()

        # Locale setting (would need implementation)
        locale_text = self.settings_locale_combo.currentText()


    def _open_file(self): #vers 1
        """Open file dialog and load COL file"""
        try:
            file_path, _ = QFileDialog.getOpenFileName(
                self,
                "Open Obj File",
                "",
                "Obj Files (*.col);;All Files (*)"
            )

            if file_path:
                self.open_obj_file(file_path)

        except Exception as e:
            img_debugger.error(f"Error in open file dialog: {str(e)}")
            QMessageBox.critical(self, "Error", f"Failed to open file:\n{str(e)}")


    def _save_file(self): #vers 1
        """Save current COL file"""
        try:
            if not self.current_col_file:
                QMessageBox.warning(self, "Save", "No Obj file loaded to save")
                return

            if not self.current_file_path:
                # No path yet, do Save As
                self._save_file_as()
                return

            # Save to current path
            if self.current_obj_file.save():
                if self.main_window and hasattr(self.main_window, 'log_message'):
                    self.main_window.log_message(f"Saved Ojb: {os.path.basename(self.current_file_path)}")

                QMessageBox.information(self, "Save", f"Obj file saved successfully:\n{os.path.basename(self.current_file_path)}")
                img_debugger.success(f"Saved Obj file: {self.current_file_path}")
            else:
                error_msg = self.current_col_file.save_error if hasattr(self.current_col_file, 'save_error') else "Unknown error"
                QMessageBox.critical(self, "Save Error", f"Failed to save Obj file:\n{error_msg}")
                img_debugger.error(f"Save failed: {error_msg}")

        except Exception as e:
            img_debugger.error(f"Error saving file: {str(e)}")
            QMessageBox.critical(self, "Error", f"Failed to save file:\n{str(e)}")


    def _save_file_as(self): #vers 1
        """Save As dialog"""
        try:
            file_path, _ = QFileDialog.getSaveFileName(
                self,
                "Save Obj File As",
                "",
                "Obj Files (*.col);;All Files (*)"
            )

            if file_path:
                self.current_file_path = file_path
                self.current_col_file.file_path = file_path
                self._save_file()

        except Exception as e:
            img_debugger.error(f"Error in save as dialog: {str(e)}")
            QMessageBox.critical(self, "Error", f"Failed to save file:\n{str(e)}")


    def _load_settings(self): #vers 1
        """Load settings from config file"""
        import json

        settings_file = os.path.join(
            os.path.dirname(__file__),
            'obj_workshop_settings.json'
        )

        try:
            if os.path.exists(settings_file):
                with open(settings_file, 'r') as f:
                    settings = json.load(f)
                    self.save_to_source_location = settings.get('save_to_source_location', True)
                    self.last_save_directory = settings.get('last_save_directory', None)
        except Exception as e:
            print(f"Failed to load settings: {e}")


    def _save_settings(self): #vers 1
        """Save settings to config file"""
        import json

        settings_file = os.path.join(
            os.path.dirname(__file__),
            'obj_workshop_settings.json'
        )

        try:
            settings = {
                'save_to_source_location': self.save_to_source_location,
                'last_save_directory': self.last_save_directory
            }

            with open(settings_file, 'w') as f:
                json.dump(settings, indent=2, fp=f)
        except Exception as e:
            print(f"Failed to save settings: {e}")

# - Hotkeys sections

    def _setup_hotkeys(self): #vers 3
        """Setup Plasma6-style keyboard shortcuts for this application - checks for existing methods"""
        from PyQt6.QtGui import QShortcut, QKeySequence
        from PyQt6.QtCore import Qt

        # === FILE OPERATIONS ===

        # Open col (Ctrl+O)
        self.hotkey_open = QShortcut(QKeySequence.StandardKey.Open, self)
        if hasattr(self, 'open_col_file'):
            self.hotkey_open.activated.connect(self.open_col_file)
        elif hasattr(self, '_open_col_file'):
            self.hotkey_open.activated.connect(self._open_col_file)

        # Save col (Ctrl+S)
        self.hotkey_save = QShortcut(QKeySequence.StandardKey.Save, self)
        if hasattr(self, '_save_col_file'):
            self.hotkey_save.activated.connect(self._save_col_file)
        elif hasattr(self, 'save_col_file'):
            self.hotkey_save.activated.connect(self.save_col_file)

        # Force Save col (Alt+Shift+S)
        self.hotkey_force_save = QShortcut(QKeySequence("Alt+Shift+S"), self)
        if not hasattr(self, '_force_save_col'):
            # Create force save method inline if it doesn't exist
            def force_save():
                if not self.collision_list:
                    from PyQt6.QtWidgets import QMessageBox
                    QMessageBox.warning(self, "No Collision", "No Collision to save")
                    return
                if self.main_window and hasattr(self.main_window, 'log_message'):
                    self.main_window.log_message("Force save triggered (Alt+Shift+S)")
                # Call save regardless of modified state
                if hasattr(self, '_save_col_file'):
                    self._save_col_file()

            self.hotkey_force_save.activated.connect(force_save)
        else:
            self.hotkey_force_save.activated.connect(self._force_save_col)

        # Save As (Ctrl+Shift+S)
        self.hotkey_save_as = QShortcut(QKeySequence.StandardKey.SaveAs, self)
        if hasattr(self, '_save_as_col_file'):
            self.hotkey_save_as.activated.connect(self._save_as_col_file)
        elif hasattr(self, '_save_col_file'):
            self.hotkey_save_as.activated.connect(self._save_col_file)

        # Close (Ctrl+W)
        self.hotkey_close = QShortcut(QKeySequence.StandardKey.Close, self)
        self.hotkey_close.activated.connect(self.close)

        # === EDIT OPERATIONS ===

        # Undo (Ctrl+Z)
        self.hotkey_undo = QShortcut(QKeySequence.StandardKey.Undo, self)
        if hasattr(self, '_undo_last_action'):
            self.hotkey_undo.activated.connect(self._undo_last_action)
        # else: not implemented yet, no connection

        # Copy (Ctrl+C)
        self.hotkey_copy = QShortcut(QKeySequence.StandardKey.Copy, self)
        if hasattr(self, '_copy_collision'):
            self.hotkey_copy.activated.connect(self._copy_surface)


        # Paste (Ctrl+V)
        self.hotkey_paste = QShortcut(QKeySequence.StandardKey.Paste, self)
        if hasattr(self, '_paste_collision'):
            self.hotkey_paste.activated.connect(self._paste_surface)


        # Delete (Delete)
        self.hotkey_delete = QShortcut(QKeySequence.StandardKey.Delete, self)
        if hasattr(self, '_delete_collision'):
            self.hotkey_delete.activated.connect(self._delete_surface)


        # Duplicate (Ctrl+D)
        self.hotkey_duplicate = QShortcut(QKeySequence("Ctrl+D"), self)
        if hasattr(self, '_duplicate_collision'):
            self.hotkey_duplicate.activated.connect(self._duplicate_surface)


        # Rename (F2)
        self.hotkey_rename = QShortcut(QKeySequence("F2"), self)
        if not hasattr(self, '_rename_collsion_shortcut'):
            # Create rename shortcut method inline
            def rename_shortcut():
                # Focus the name input field if it exists
                if hasattr(self, 'info_name'):
                    self.info_name.setReadOnly(False)
                    self.info_name.selectAll()
                    self.info_name.setFocus()
            self.hotkey_rename.activated.connect(rename_shortcut)
        else:
            self.hotkey_rename.activated.connect(self._rename_shadow_shortcut)

        # === Collision OPERATIONS ===

        # Import Collision (Ctrl+I)
        self.hotkey_import = QShortcut(QKeySequence("Ctrl+I"), self)
        if hasattr(self, '_import_collision'):
            self.hotkey_import.activated.connect(self._import_surface)

        # Export Collision (Ctrl+E)
        self.hotkey_export = QShortcut(QKeySequence("Ctrl+E"), self)
        if hasattr(self, 'export_selected_collision'):
            self.hotkey_export.activated.connect(self.export_selected_surface)

        # Export All (Ctrl+Shift+E)
        self.hotkey_export_all = QShortcut(QKeySequence("Ctrl+Shift+E"), self)
        if hasattr(self, 'export_all_collision'):
            self.hotkey_export_all.activated.connect(self.export_all_surfaces)


        # === VIEW OPERATIONS ===

        # Refresh (F5)d_btn
        self.hotkey_refresh = QShortcut(QKeySequence.StandardKey.Refresh, self)
        if hasattr(self, '_reload_surface_table'):
            self.hotkey_refresh.activated.connect(self._reload_surface_table)
        elif hasattr(self, 'reload_surface_table'):
            self.hotkey_refresh.activated.connect(self.reload_surface_table)
        elif hasattr(self, 'refresh'):
            self.hotkey_refresh.activated.connect(self.refresh)

        # Properties (Alt+Enter)
        self.hotkey_properties = QShortcut(QKeySequence("Alt+Return"), self)
        if hasattr(self, '_show_detailed_info'):
            self.hotkey_properties.activated.connect(self._show_detailed_info)
        elif hasattr(self, '_show_surface_info'):
            self.hotkey_properties.activated.connect(self._show_surface_info)

        # Settings (Ctrl+,)
        self.hotkey_settings = QShortcut(QKeySequence.StandardKey.Preferences, self)
        if hasattr(self, '_show_settings_dialog'):
            self.hotkey_settings.activated.connect(self._show_settings_dialog)
        elif hasattr(self, 'show_settings_dialog'):
            self.hotkey_settings.activated.connect(self.show_settings_dialog)
        elif hasattr(self, '_show_settings_hotkeys'):
            self.hotkey_settings.activated.connect(self._show_settings_hotkeys)

        # === NAVIGATION ===

        # Select All (Ctrl+A) - reserved for future
        self.hotkey_select_all = QShortcut(QKeySequence.StandardKey.SelectAll, self)
        # Not connected - reserved for future multi-select

        # Find (Ctrl+F)
        self.hotkey_find = QShortcut(QKeySequence.StandardKey.Find, self)
        if not hasattr(self, '_focus_search'):
            # Create focus search method inline
            def focus_search():
                if hasattr(self, 'search_input'):
                    self.search_input.setFocus()
                    self.search_input.selectAll()
            self.hotkey_find.activated.connect(focus_search)
        else:
            self.hotkey_find.activated.connect(self._focus_search)

        # === HELP ===

        # Help (F1)
        self.hotkey_help = QShortcut(QKeySequence.StandardKey.HelpContents, self)

        if hasattr(self, 'show_help'):
            self.hotkey_help.activated.connect(self.show_help)

        if self.main_window and hasattr(self.main_window, 'log_message'):
            self.main_window.log_message("Hotkeys initialized (Plasma6 standard)")


    def _reset_hotkeys_to_defaults(self, parent_dialog): #vers 1
        """Reset all hotkeys to Plasma6 defaults"""
        from PyQt6.QtWidgets import QMessageBox
        from PyQt6.QtGui import QKeySequence

        reply = QMessageBox.question(parent_dialog, "Reset Hotkeys",
            "Reset all keyboard shortcuts to Plasma6 defaults?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)

        if reply == QMessageBox.StandardButton.Yes:
            # Reset to defaults
            self.hotkey_edit_open.setKeySequence(QKeySequence.StandardKey.Open)
            self.hotkey_edit_save.setKeySequence(QKeySequence.StandardKey.Save)
            self.hotkey_edit_force_save.setKeySequence(QKeySequence("Alt+Shift+S"))
            self.hotkey_edit_save_as.setKeySequence(QKeySequence.StandardKey.SaveAs)
            self.hotkey_edit_close.setKeySequence(QKeySequence.StandardKey.Close)
            self.hotkey_edit_undo.setKeySequence(QKeySequence.StandardKey.Undo)
            self.hotkey_edit_copy.setKeySequence(QKeySequence.StandardKey.Copy)
            self.hotkey_edit_paste.setKeySequence(QKeySequence.StandardKey.Paste)
            self.hotkey_edit_delete.setKeySequence(QKeySequence.StandardKey.Delete)
            self.hotkey_edit_duplicate.setKeySequence(QKeySequence("Ctrl+D"))
            self.hotkey_edit_rename.setKeySequence(QKeySequence("F2"))
            self.hotkey_edit_import.setKeySequence(QKeySequence("Ctrl+I"))
            self.hotkey_edit_export.setKeySequence(QKeySequence("Ctrl+E"))
            self.hotkey_edit_export_all.setKeySequence(QKeySequence("Ctrl+Shift+E"))
            self.hotkey_edit_refresh.setKeySequence(QKeySequence.StandardKey.Refresh)
            self.hotkey_edit_properties.setKeySequence(QKeySequence("Alt+Return"))
            self.hotkey_edit_find.setKeySequence(QKeySequence.StandardKey.Find)
            self.hotkey_edit_help.setKeySequence(QKeySequence.StandardKey.HelpContents)


    def _apply_hotkey_settings(self, dialog, close=False): #vers 1
        """Apply hotkey changes"""
        # Update all hotkeys with new sequences
        self.hotkey_open.setKey(self.hotkey_edit_open.keySequence())
        self.hotkey_save.setKey(self.hotkey_edit_save.keySequence())
        self.hotkey_force_save.setKey(self.hotkey_edit_force_save.keySequence())
        self.hotkey_save_as.setKey(self.hotkey_edit_save_as.keySequence())
        self.hotkey_close.setKey(self.hotkey_edit_close.keySequence())
        self.hotkey_undo.setKey(self.hotkey_edit_undo.keySequence())
        self.hotkey_copy.setKey(self.hotkey_edit_copy.keySequence())
        self.hotkey_paste.setKey(self.hotkey_edit_paste.keySequence())
        self.hotkey_delete.setKey(self.hotkey_edit_delete.keySequence())
        self.hotkey_duplicate.setKey(self.hotkey_edit_duplicate.keySequence())
        self.hotkey_rename.setKey(self.hotkey_edit_rename.keySequence())
        self.hotkey_import.setKey(self.hotkey_edit_import.keySequence())
        self.hotkey_export.setKey(self.hotkey_edit_export.keySequence())
        self.hotkey_export_all.setKey(self.hotkey_edit_export_all.keySequence())
        self.hotkey_refresh.setKey(self.hotkey_edit_refresh.keySequence())
        self.hotkey_properties.setKey(self.hotkey_edit_properties.keySequence())
        self.hotkey_find.setKey(self.hotkey_edit_find.keySequence())
        self.hotkey_help.setKey(self.hotkey_edit_help.keySequence())

        if self.main_window and hasattr(self.main_window, 'log_message'):
            self.main_window.log_message("Hotkeys updated")

        # TODO: Save to config file for persistence

        if close:
            dialog.accept()


    def _show_settings_hotkeys(self): #vers 1
        """Show settings dialog with hotkey customization"""
        from PyQt6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QTabWidget,
                                    QWidget, QLabel, QLineEdit, QPushButton,
                                    QGroupBox, QFormLayout, QKeySequenceEdit)
        from PyQt6.QtCore import Qt

        dialog = QDialog(self)
        dialog.setWindowTitle(App_name + " Settings")
        dialog.setMinimumWidth(600)
        dialog.setMinimumHeight(500)

        layout = QVBoxLayout(dialog)

        # Create tabs
        tabs = QTabWidget()

        # === HOTKEYS TAB ===
        hotkeys_tab = QWidget()
        hotkeys_layout = QVBoxLayout(hotkeys_tab)

        # File Operations Group
        file_group = QGroupBox("File Operations")
        file_form = QFormLayout()

        self.hotkey_edit_open = QKeySequenceEdit(self.hotkey_open.key())
        file_form.addRow("Open col:", self.hotkey_edit_open)

        self.hotkey_edit_save = QKeySequenceEdit(self.hotkey_save.key())
        file_form.addRow("Save col:", self.hotkey_edit_save)

        self.hotkey_edit_force_save = QKeySequenceEdit(self.hotkey_force_save.key())
        force_save_layout = QHBoxLayout()
        force_save_layout.addWidget(self.hotkey_edit_force_save)
        force_save_hint = QLabel("(Force save even if unmodified)")
        force_save_hint.setStyleSheet("color: #888; font-style: italic;")
        force_save_layout.addWidget(force_save_hint)
        file_form.addRow("Force Save:", force_save_layout)

        self.hotkey_edit_save_as = QKeySequenceEdit(self.hotkey_save_as.key())
        file_form.addRow("Save As:", self.hotkey_edit_save_as)

        self.hotkey_edit_close = QKeySequenceEdit(self.hotkey_close.key())
        file_form.addRow("Close:", self.hotkey_edit_close)

        file_group.setLayout(file_form)
        hotkeys_layout.addWidget(file_group)

        # Edit Operations Group
        edit_group = QGroupBox("Edit Operations")
        edit_form = QFormLayout()

        self.hotkey_edit_undo = QKeySequenceEdit(self.hotkey_undo.key())
        edit_form.addRow("Undo:", self.hotkey_edit_undo)

        self.hotkey_edit_copy = QKeySequenceEdit(self.hotkey_copy.key())
        edit_form.addRow("Copy Collision:", self.hotkey_edit_copy)

        self.hotkey_edit_paste = QKeySequenceEdit(self.hotkey_paste.key())
        edit_form.addRow("Paste Collision:", self.hotkey_edit_paste)

        self.hotkey_edit_delete = QKeySequenceEdit(self.hotkey_delete.key())
        edit_form.addRow("Delete:", self.hotkey_edit_delete)

        self.hotkey_edit_duplicate = QKeySequenceEdit(self.hotkey_duplicate.key())
        edit_form.addRow("Duplicate:", self.hotkey_edit_duplicate)

        self.hotkey_edit_rename = QKeySequenceEdit(self.hotkey_rename.key())
        edit_form.addRow("Rename:", self.hotkey_edit_rename)

        edit_group.setLayout(edit_form)
        hotkeys_layout.addWidget(edit_group)

        # Collision Group
        coll_group = QGroupBox("Collision Operations")
        coll_form = QFormLayout()

        self.hotkey_edit_import = QKeySequenceEdit(self.hotkey_import.key())
        coll_form.addRow("Import Collision:", self.hotkey_edit_import)

        self.hotkey_edit_export = QKeySequenceEdit(self.hotkey_export.key())
        coll_form.addRow("Export Collision:", self.hotkey_edit_export)

        self.hotkey_edit_export_all = QKeySequenceEdit(self.hotkey_export_all.key())
        coll_form.addRow("Export All:", self.hotkey_edit_export_all)

        coll_group.setLayout(coll_form)
        hotkeys_layout.addWidget(coll_group)

        # View Operations Group
        view_group = QGroupBox("View Operations")
        view_form = QFormLayout()

        self.hotkey_edit_refresh = QKeySequenceEdit(self.hotkey_refresh.key())
        view_form.addRow("Refresh:", self.hotkey_edit_refresh)

        self.hotkey_edit_properties = QKeySequenceEdit(self.hotkey_properties.key())
        view_form.addRow("Properties:", self.hotkey_edit_properties)

        self.hotkey_edit_find = QKeySequenceEdit(self.hotkey_find.key())
        view_form.addRow("Find/Search:", self.hotkey_edit_find)

        self.hotkey_edit_help = QKeySequenceEdit(self.hotkey_help.key())
        view_form.addRow("Help:", self.hotkey_edit_help)

        view_group.setLayout(view_form)
        hotkeys_layout.addWidget(view_group)

        hotkeys_layout.addStretch()

        # Reset to defaults button
        reset_hotkeys_btn = QPushButton("Reset to Plasma6 Defaults")
        reset_hotkeys_btn.clicked.connect(lambda: self._reset_hotkeys_to_defaults(dialog))
        hotkeys_layout.addWidget(reset_hotkeys_btn)

        tabs.addTab(hotkeys_tab, "Keyboard Shortcuts")

        # === GENERAL TAB (for future settings) ===
        general_tab = QWidget()
        general_layout = QVBoxLayout(general_tab)

        placeholder_label = QLabel("Additional settings will appear here in future versions.")
        placeholder_label.setStyleSheet("color: #888; font-style: italic; padding: 20px;")
        placeholder_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        general_layout.addWidget(placeholder_label)
        general_layout.addStretch()

        tabs.addTab(general_tab, "General")

        layout.addWidget(tabs)

        # Dialog buttons
        button_layout = QHBoxLayout()
        button_layout.addStretch()

        cancel_btn = QPushButton("Cancel")
        cancel_btn.clicked.connect(dialog.reject)
        button_layout.addWidget(cancel_btn)

        apply_btn = QPushButton("Apply")
        apply_btn.clicked.connect(lambda: self._apply_hotkey_settings(dialog))
        button_layout.addWidget(apply_btn)

        ok_btn = QPushButton("OK")
        ok_btn.setDefault(True)
        ok_btn.clicked.connect(lambda: self._apply_hotkey_settings(dialog, close=True))
        button_layout.addWidget(ok_btn)

        layout.addLayout(button_layout)

        dialog.exec()

# - GUI Events, MouseButton interactions

    def keyPressEvent(self, event): #vers 1
        """Handle keyboard shortcuts"""
        from PyQt6.QtCore import Qt

        # D key - Dock/Undock toggle
        if event.key() == Qt.Key.Key_D and not event.modifiers():
            self.toggle_dock_mode()
            event.accept()
            return

        # T key - Tear out (same as undock)
        if event.key() == Qt.Key.Key_T and not event.modifiers():
            if self.is_docked:
                self._undock_from_main()
            event.accept()
            return

        super().keyPressEvent(event)

    def keyPressEvent(self, event): #vers 1_updated
        """Handle keyboard shortcuts including Research DB"""
        from PyQt6.QtCore import Qt

        # Ctrl+R - Research Database
        if event.key() == Qt.Key.Key_R and event.modifiers() == Qt.KeyboardModifier.ControlModifier:
            self._on_research_clicked()
            event.accept()
            return

        # Your existing key handlers...
        super().keyPressEvent(event)

    def _enable_move_mode(self): #vers 2
        # Enable move window mode using system move
        # Use Qt's system move which works on Windows, Linux, etc.
        if hasattr(self.windowHandle(), 'startSystemMove'):
            self.windowHandle().startSystemMove()
        else:
            from PyQt6.QtWidgets import QMessageBox
            QMessageBox.information(self, "Move Window",
                "Drag the titlebar to move the window")


    def _toggle_upscale_native(self): #vers 1
        # Toggle upscale native resolution
        # Placeholder for upscale native functionality
        print("Upscale Native toggled")


    def _is_on_draggable_area(self, pos): #vers 7
        """Check if position is on draggable titlebar area

        Args:
            pos: Position in titlebar coordinates (from eventFilter)

        Returns:
            True if position is on titlebar but not on any button
        """
        if not hasattr(self, 'titlebar'):
            print("[DRAG] No titlebar attribute"); return False

        # Verify pos is within titlebar bounds
        if not self.titlebar.rect().contains(pos):
            print(f"[DRAG] Position {pos} outside titlebar rect {self.titlebar.rect()}")
            return False

        # Check if clicking on any button - if so, NOT draggable
        for widget in self.titlebar.findChildren(QPushButton):
            if widget.isVisible():
                # Get button geometry in titlebar coordinates
                button_rect = widget.geometry()
                if button_rect.contains(pos):
                    print(f"[DRAG] Clicked on button: {widget.toolTip()}")
                    return False

        # Not on any button = draggable
        print(f"[DRAG] On draggable area at {pos}")
        return True


    def _apply_always_on_top(self): #vers 1
        """Apply always on top window flag"""
        current_flags = self.windowFlags()

        if self.window_always_on_top:
            new_flags = current_flags | Qt.WindowType.WindowStaysOnTopHint
        else:
            new_flags = current_flags & ~Qt.WindowType.WindowStaysOnTopHint

        if new_flags != current_flags:
            # Save state
            current_geometry = self.geometry()
            was_visible = self.isVisible()

            self.setWindowFlags(new_flags)

            self.setGeometry(current_geometry)
            if was_visible:
                self.show()


    def keyPressEvent(self, event): #ver 1
        if event.key() == Qt.Key.Key_D and not event.modifiers():
            self.toggle_dock_mode(); event.accept(); return

        if event.key() == Qt.Key.Key_T and not event.modifiers():
            if self.is_docked: self._undock_from_main(); event.accept(); return

        super().keyPressEvent(event)


    def paintEvent(self, event): #vers 2
        """Paint corner resize triangles"""
        super().paintEvent(event)

        from PyQt6.QtGui import QPainter, QColor, QPen, QBrush, QPainterPath

        painter = QPainter(self)
        painter.setRenderHint(QPainter.RenderHint.Antialiasing)

        # Colors
        normal_color = QColor(100, 100, 100, 150)
        hover_color = QColor(150, 150, 255, 200)

        w = self.width()
        h = self.height()
        grip_size = 8  # Make corners visible (8x8px)
        size = self.corner_size

        # Define corner triangles
        corners = {
            'top-left': [(0, 0), (size, 0), (0, size)],
            'top-right': [(w, 0), (w-size, 0), (w, size)],
            'bottom-left': [(0, h), (size, h), (0, h-size)],
            'bottom-right': [(w, h), (w-size, h), (w, h-size)]
        }
        corners2 = {
            "top-left": [(0, grip_size), (0, 0), (grip_size, 0)],
            "top-right": [(w-grip_size, 0), (w, 0), (w, grip_size)],
            "bottom-left": [(0, h-grip_size), (0, h), (grip_size, h)],
            "bottom-right": [(w-grip_size, h), (w, h), (w, h-grip_size)]
        }

        # Get theme colors for corner indicators
        if self.app_settings:
            theme_colors = self._get_theme_colors("default")
            accent_color = QColor(theme_colors.get('accent_primary', '#1976d2'))
            accent_color.setAlpha(180)
        else:
            accent_color = QColor(100, 150, 255, 180)

        hover_color = QColor(accent_color)
        hover_color.setAlpha(255)

        # Draw all corners with hover effect
        for corner_name, points in corners.items():
            path = QPainterPath()
            path.moveTo(points[0][0], points[0][1])
            path.lineTo(points[1][0], points[1][1])
            path.lineTo(points[2][0], points[2][1])
            path.closeSubpath()

            # Use hover color if mouse is over this corner
            color = hover_color if self.hover_corner == corner_name else accent_color

            painter.setPen(Qt.PenStyle.NoPen)
            painter.setBrush(QBrush(color))
            painter.drawPath(path)

        painter.end()


    def _get_resize_corner(self, pos): #vers 3
        """Determine which corner is under mouse position"""
        size = self.corner_size; w = self.width(); h = self.height()

        if pos.x() < size and pos.y() < size:
            return "top-left"
        if pos.x() > w - size and pos.y() < size:
            return "top-right"
        if pos.x() < size and pos.y() > h - size:
            return "bottom-left"
        if pos.x() > w - size and pos.y() > h - size:
            return "bottom-right"

        return None

    def mouseMoveEvent(self, event): #vers 4
        """Handle mouse move for resizing and hover effects

        Window dragging is handled by eventFilter to avoid conflicts
        """
        if event.buttons() == Qt.MouseButton.LeftButton:
            if self.resizing and self.resize_corner:
                self._handle_corner_resize(event.globalPosition().toPoint())
                event.accept()
                return
        else:
            # Update hover state and cursor
            corner = self._get_resize_corner(event.pos())
            if corner != self.hover_corner:
                self.hover_corner = corner
                self.update()  # Trigger repaint for hover effect
            self._update_cursor(corner)

        # Let parent handle everything else
        super().mouseMoveEvent(event)


    def mouseReleaseEvent(self, event): #vers 2
        """Handle mouse release"""
        if event.button() == Qt.MouseButton.LeftButton:
            self.dragging = False
            self.resizing = False
            self.resize_corner = None
            self.setCursor(Qt.CursorShape.ArrowCursor)
            event.accept()


    # mousePressEvent with this logic:
    def mousePressEvent(self, event): #vers 8
        """Handle ALL mouse press - dragging and resizing"""
        if event.button() != Qt.MouseButton.LeftButton:
            super().mousePressEvent(event)
            return

        pos = event.pos()

        # Check corner resize FIRST
        self.resize_corner = self._get_resize_corner(pos)
        if self.resize_corner:
            self.resizing = True
            self.drag_position = event.globalPosition().toPoint()
            self.initial_geometry = self.geometry()
            event.accept()
            return

        # Check if on titlebar
        if hasattr(self, 'titlebar') and self.titlebar.geometry().contains(pos):
            titlebar_pos = self.titlebar.mapFromParent(pos)
            if self._is_on_draggable_area(titlebar_pos):
                self.windowHandle().startSystemMove()
                event.accept()
                return

        super().mousePressEvent(event)


    def _handle_corner_resize(self, global_pos): #vers 2
        """Handle window resizing from corners"""
        if not self.resize_corner or not self.drag_position:
            return

        delta = global_pos - self.drag_position
        geometry = self.initial_geometry

        min_width = 800
        min_height = 600

        # Calculate new geometry based on corner
        if self.resize_corner == "top-left":
            # Move top-left corner
            new_x = geometry.x() + delta.x()
            new_y = geometry.y() + delta.y()
            new_width = geometry.width() - delta.x()
            new_height = geometry.height() - delta.y()

            if new_width >= min_width and new_height >= min_height:
                self.setGeometry(new_x, new_y, new_width, new_height)

        elif self.resize_corner == "top-right":
            # Move top-right corner
            new_y = geometry.y() + delta.y()
            new_width = geometry.width() + delta.x()
            new_height = geometry.height() - delta.y()

            if new_width >= min_width and new_height >= min_height:
                self.setGeometry(geometry.x(), new_y, new_width, new_height)

        elif self.resize_corner == "bottom-left":
            # Move bottom-left corner
            new_x = geometry.x() + delta.x()
            new_width = geometry.width() - delta.x()
            new_height = geometry.height() + delta.y()

            if new_width >= min_width and new_height >= min_height:
                self.setGeometry(new_x, geometry.y(), new_width, new_height)

        elif self.resize_corner == "bottom-right":
            # Move bottom-right corner
            new_width = geometry.width() + delta.x()
            new_height = geometry.height() + delta.y()

            if new_width >= min_width and new_height >= min_height:
                self.resize(new_width, new_height)


    def _get_resize_direction(self, pos): #vers 1
        """Determine resize direction based on mouse position"""
        rect = self.rect()
        margin = self.resize_margin

        left = pos.x() < margin
        right = pos.x() > rect.width() - margin
        top = pos.y() < margin
        bottom = pos.y() > rect.height() - margin

        if left and top:
            return "top-left"
        elif right and top:
            return "top-right"
        elif left and bottom:
            return "bottom-left"
        elif right and bottom:
            return "bottom-right"
        elif left:
            return "left"
        elif right:
            return "right"
        elif top:
            return "top"
        elif bottom:
            return "bottom"

        return None


    def _update_cursor(self, direction): #vers 1
        """Update cursor based on resize direction"""
        if direction == "top" or direction == "bottom":
            self.setCursor(Qt.CursorShape.SizeVerCursor)
        elif direction == "left" or direction == "right":
            self.setCursor(Qt.CursorShape.SizeHorCursor)
        elif direction == "top-left" or direction == "bottom-right":
            self.setCursor(Qt.CursorShape.SizeFDiagCursor)
        elif direction == "top-right" or direction == "bottom-left":
            self.setCursor(Qt.CursorShape.SizeBDiagCursor)
        else:
            self.setCursor(Qt.CursorShape.ArrowCursor)


    def _handle_resize(self, global_pos): #vers 1
        """Handle window resizing"""
        if not self.resize_direction or not self.drag_position:
            return

        delta = global_pos - self.drag_position
        geometry = self.frameGeometry()

        min_width = 800
        min_height = 600

        # Handle horizontal resizing
        if "left" in self.resize_direction:
            new_width = geometry.width() - delta.x()
            if new_width >= min_width:
                geometry.setLeft(geometry.left() + delta.x())
        elif "right" in self.resize_direction:
            new_width = geometry.width() + delta.x()
            if new_width >= min_width:
                geometry.setRight(geometry.right() + delta.x())

        # Handle vertical resizing
        if "top" in self.resize_direction:
            new_height = geometry.height() - delta.y()
            if new_height >= min_height:
                geometry.setTop(geometry.top() + delta.y())
        elif "bottom" in self.resize_direction:
            new_height = geometry.height() + delta.y()
            if new_height >= min_height:
                geometry.setBottom(geometry.bottom() + delta.y())

        self.setGeometry(geometry)
        self.drag_position = global_pos


    def resizeEvent(self, event): #vers 1
        '''Keep resize grip in bottom-right corner'''
        super().resizeEvent(event)
        if hasattr(self, 'size_grip'):
            self.size_grip.move(self.width() - 16, self.height() - 16)


    def mouseDoubleClickEvent(self, event): #vers 2
        """Handle double-click - maximize/restore

        Handled here instead of eventFilter for better control
        """
        if event.button() == Qt.MouseButton.LeftButton:
            # Convert to titlebar coordinates if needed
            if hasattr(self, 'titlebar'):
                titlebar_pos = self.titlebar.mapFromParent(event.pos())
                if self._is_on_draggable_area(titlebar_pos):
                    self._toggle_maximize()
                    event.accept()
                    return

        super().mouseDoubleClickEvent(event)

    def _toggle_maximize(self): #vers 1
        #Toggle window maximize state
        if self.isMaximized():
            self.showNormal()
        else:
            self.showMaximized()


    def closeEvent(self, event): #ver 1
        self.window_closed.emit()
        event.accept()


